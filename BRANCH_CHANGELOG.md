# Branch Changelog: `distributed-poc-10-10`

## Query ID Architecture Changes

### Local Query IDs → UUIDs

**Breaking Change**: Local query IDs have been migrated from integer counters to UUIDs.

- **Previous**: `LocalQueryId(1)`, `LocalQueryId(2)`, etc.
- **New**: `LocalQueryId(generateUUID())` → e.g., `"741b827a-ec15-4b9f-a29e-661b12b74696"`

### Query ID Lifecycle Change

Query IDs are now generated **at the worker** when `startQuery` is called, rather than being embedded in the
`ExecutableQueryPlan`.

**Previous flow:**

```cpp
auto [queryId, query] = test.addNewQuery(...);
// queryId was part of the query object
auto returnedId = test.startQuery(std::move(query));
```

**New flow:**

```cpp
auto [queryId, query] = test.addNewQuery(...);
// queryId is generated by startQuery, not stored in plan
test.startQuery(queryId, std::move(query));
```

### Distributed Query IDs

Distributed query IDs are now string-based and random enough to eliminate the need for mappings:

- **Previous**: `nebucli` maintained a mapping from numeric distributed query IDs to temporary file names
- **New**: Distributed query IDs are self-contained strings (e.g., `"agile_warmblood0"`)

## SQL Parser Changes

### Query ID Literals

The parser went through two iterations for handling query IDs:

1. **Initial approach**: Introduced UUIDs as first-class literals that bypass identifier rules
2. **Distributed branch approach**: Reverted to treating query IDs as regular strings

### String Handling Inconsistencies

The parser currently has inconsistent string/identifier handling:

| SQL Construct           | Expected Format            | Example                            |
|-------------------------|----------------------------|------------------------------------|
| `WHERE id = <query_id>` | String literal with quotes | `WHERE id = '741b827a-...'`        |
| `DROP QUERY <query_id>` | Identifier without quotes  | ``DROP QUERY `agile_warmblood0` `` |
| Logical source names    | String literal             | `WHERE source = 'ENDLESS'`         |

**Problem**: Query IDs are generated as lowercase UUIDs, but SQL defaults to uppercase identifiers. This means:

- Query IDs as identifiers require backticks: `` DROP QUERY `741b827a-...` ``
- Query IDs in WHERE clauses need quotes: `WHERE id = '741b827a-...'`

## Testing Infrastructure Changes

### SQL Test Migration Challenge

**Problem**: Existing SQL tests expected query IDs to be sequential integers starting from 1:

```sql
-- Old tests
SELECT ... INTO sink;  -- Would get query ID 1
SHOW QUERIES WHERE id = 1;
DROP QUERY 1;
```

**Workaround**: Implemented a macro-like replacement system (acknowledged as "ugly") to handle the UUID transition in
existing tests.

### New Interactive Expect Test

Created a comprehensive expect-based test (`test_query.exp`) to replace the bats test and eliminate the
`%LAST_QUERY_ID%` hack.

**Features:**

- Extracts actual query IDs from JSON responses
- Uses extracted IDs in subsequent SQL commands
- Silent on success, shows detailed errors on failure
- Helper procedures extracted to `helpers.exp` for reusability

**Test Coverage:**

1. CREATE LOGICAL SOURCE
2. CREATE PHYSICAL SOURCE
3. CREATE SINK
4. SHOW QUERIES (empty)
5. SELECT query with query ID extraction
6. SHOW QUERIES (with running query, validates ID matches)
7. SHOW QUERIES WHERE id = <extracted_id>
8. DROP QUERY <extracted_id>
9. SHOW QUERIES (after drop)

**Helper Procedures:**

- `wait_for_prompt` - Wraps the NES emoji prompt
- `fail` - Centralized failure reporting
- `expect_json` - Expects JSON response and returns it
- `expect_json_equal` - Expects JSON and asserts equality
- `clean_json` - Removes ANSI codes from terminal output
- `extract_json_from_buffer` - Extracts JSON array from expect buffer
- `assert_json_equal` - Asserts JSON equality using jq
- `assert_json_contains` - Asserts JSON contains expected subset

## Migration Guide

### For C++ Tests

```cpp
// OLD
LocalQueryId qid1(1);
LocalQueryId qid2(2);

// NEW
auto qid1 = LocalQueryId(generateUUID());
auto qid2 = LocalQueryId(generateUUID());
```

### For SQL Tests

Query IDs can no longer be hardcoded. Use one of:

1. **Expect tests** (recommended): Extract query IDs from JSON responses
2. **Macro replacement**: Use the workaround system (temporary solution)

### For DistributedQueryId

```cpp
// OLD
DistributedQueryId(1)

// NEW
DistributedQueryId("test-distributed-query-1")  // Or any unique string
```

## Known Issues

1. **Parser inconsistency**: Query IDs require different quoting depending on context (string vs identifier)
2. **Case sensitivity**: Generated UUIDs are lowercase, requiring backticks in identifier contexts
3. **SQL test migration**: Legacy tests use "ugly" macro workaround pending full migration to expect tests
4. **String literal handling**: Parser treats strings differently in WHERE clauses vs DROP QUERY statements

## Files Changed

### Test Infrastructure

- `nes-nebuli/apps/repl/tests/test_query.exp` - New expect test with query ID extraction
- `nes-nebuli/apps/repl/tests/helpers.exp` - Reusable expect helper procedures
- `nes-nebuli/apps/repl/tests/nebuli_invocation_test.bats` - Updated for UUID-based query IDs
- `nes-query-engine/tests/QueryEngineTest.cpp` - Migrated to UUID-based LocalQueryId
- `nes-query-engine/tests/Util/QueryEngineTestingInfrastructure.{hpp,cpp}` - Updated startQuery signature
- `nes-nebuli/tests/DistributedQueryTest.cpp` - Migrated to UUID/string-based query IDs
- `nes-logical-operators/tests/LogicalPlanTest.cpp` - Updated test infrastructure

### Core Changes

- `nes-nebuli/include/DistributedQuery.hpp` - Updated query ID types
- `nes-nebuli/src/DistributedQuery.cpp` - Removed query ID from ExecutableQueryPlan
- SQL Parser - Added/removed UUID literal support (reverted in distributed branch)

## Future Work

1. Unify string/identifier handling in SQL parser for query IDs
2. Migrate remaining SQL tests from macro workaround to expect tests
3. Consider case-insensitive identifier matching or uppercase UUID generation
4. Standardize query ID format in SQL syntax across all commands
