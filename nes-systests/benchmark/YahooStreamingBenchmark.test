# name: milestone/YahooStreamingBenchmark.test
# description: YahooStreamingBenchmark queries (https://github.com/yahoo/streaming-benchmarks) with changed data types
# groups: [milestone, benchmark, large, Aggregation]

# Source definitions
CREATE LOGICAL SOURCE ysb1k(user_id UINT64 NOT NULL, page_id UINT64 NOT NULL, campaign_id UINT64 NOT NULL, ad_type UINT64 NOT NULL, event_type UINT64 NOT NULL, current_ms UINT64 NOT NULL, ip UINT64 NOT NULL, d1 UINT64 NOT NULL, d2 UINT64 NOT NULL, d3 UINT32 NOT NULL, d4 UINT16 NOT NULL);
CREATE PHYSICAL SOURCE FOR ysb1k TYPE File;
ATTACH FILE large/ysb/ysb_1k_data_474M.csv

CREATE LOGICAL SOURCE ysb10k(user_id UINT64 NOT NULL, page_id UINT64 NOT NULL, campaign_id UINT64 NOT NULL, ad_type UINT64 NOT NULL, event_type UINT64 NOT NULL, current_ms UINT64 NOT NULL, ip UINT64 NOT NULL, d1 UINT64 NOT NULL, d2 UINT64 NOT NULL, d3 UINT32 NOT NULL, d4 UINT16 NOT NULL);
CREATE PHYSICAL SOURCE FOR ysb10k TYPE File;
ATTACH FILE large/ysb/ysb_10k_data_479M.csv

CREATE SINK ysb1kChecksum(ysb1k.start UINT64 NOT NULL, ysb1k.end UINT64 NOT NULL, ysb1k.campaign_id UINT64 NOT NULL, ysb1k.sum_user_id UINT64 NOT NULL)  TYPE Checksum;
CREATE SINK ysb10kChecksum(ysb10k.start UINT64 NOT NULL, ysb10k.end UINT64 NOT NULL, ysb10k.campaign_id UINT64 NOT NULL, ysb10k.sum_user_id UINT64 NOT NULL)  TYPE Checksum;

# Query 1 YSB with 1k campaign_ids
SELECT
    start,
    end,
    campaign_id, 
    SUM(user_id) AS sum_user_id
FROM ysb1k
WHERE event_type < UINT64(1)
GROUP BY campaign_id
WINDOW TUMBLING(current_ms, SIZE 30 SEC)
INTO ysb1kChecksum;
----
167167, 232106578


# Query 2 YSB with 10k campaign_ids
SELECT
    start,
    end,
    campaign_id,
    SUM(user_id) AS sum_user_id
FROM ysb10k
WHERE event_type < UINT64(1)
GROUP BY campaign_id
WINDOW TUMBLING(current_ms, SIZE 30 SEC)
INTO ysb10kChecksum;
----
1517953,2109797738
