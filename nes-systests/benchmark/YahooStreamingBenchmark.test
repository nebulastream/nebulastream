# name: milestone/YahooStreamingBenchmark.test
# description: YahooStreamingBenchmark queries (https://github.com/yahoo/streaming-benchmarks) with changed data types
# groups: [milestone, benchmark, large, Aggregation]

# Source definitions
Source ysb1k UINT64 user_id UINT64 page_id UINT64 campaign_id UINT64 ad_type UINT64 event_type UINT64 current_ms UINT64 ip UINT64 d1 UINT64 d2 UINT32 d3 UINT16 d4 FILE
TESTDATA/large/ysb/ysb_1k_data_474M.csv
Source ysb10k UINT64 user_id UINT64 page_id UINT64 campaign_id UINT64 ad_type UINT64 event_type UINT64 current_ms UINT64 ip UINT64 d1 UINT64 d2 UINT32 d3 UINT16 d4 FILE
TESTDATA/large/ysb/ysb_10k_data_479M.csv

SINK ysb10kChecksum TYPE Checksum UINT64 ysb10k$start UINT64 ysb10k$end UINT64 ysb10k$campaign_id UINT64 ysb10k$sum_user_id
SINK ysb1kChecksum TYPE Checksum UINT64 ysb1k$user_id UINT64 ysb1k$page_id UINT64 ysb1k$campaign_id UINT64 ysb1k$ad_type UINT64 ysb1k$event_type UINT64 ysb1k$current_ms UINT64 ysb1k$ip UINT64 ysb1k$d1 UINT64 ysb1k$d2 UINT32 ysb1k$d3 UINT16 ysb1k$d4
SINK ysb1kMapChecksum TYPE Checksum UINT64 ysb1k$user_id UINT64 click_score
SINK ysb1kSum TYPE Checksum UINT64 col1

SINK campaignStatsChecksum TYPE Checksum UINT64 ysb10k$start UINT64 ysb10k$end UINT64 ysb10k$campaign_id UINT64 ysb10k$impression_count
SINK campaignEngagementChecksum TYPE Checksum UINT64 campaign_id UINT64 impression_count UINT64 avg_engagement
SINK highValueCampaignChecksum TYPE Checksum UINT64 start UINT64 end UINT64 campaign_id UINT64 high_value_count
SINK normalizedCampaignChecksum TYPE Checksum UINT64 campaign_id UINT64 normalized_score

# Query 1: Filter 5% selectivity - ad clicks on specific pages
SELECT * FROM ysb1k WHERE page_id % UINT64(20) = UINT64(0) INTO ysb1kChecksum;
----
1870784 3210711186

# Query 2: Filter 50% selectivity - campaigns with odd IDs
SELECT * FROM ysb1k WHERE campaign_id % UINT64(2) = UINT64(1) INTO ysb1kChecksum;
----
14236360, 35170842947

# Query 3: Filter 95% selectivity - high-value impressions
SELECT * FROM ysb1k WHERE user_id > UINT64(950000) INTO ysb1kChecksum;
----
14236360, 35170842947

# Query 4: Map - calculate engagement score
SELECT user_id, (page_id + ad_type) * UINT64(10) AS click_score FROM ysb1k INTO ysb1kMapChecksum;
----
14236360, 35170842947

# Query 5: Filter and Map 5% selectivity - calculate engagement score for specific ads
SELECT user_id, (page_id + ad_type) * UINT64(10) AS click_score
FROM (SELECT user_id, page_id, ad_type FROM ysb1k WHERE page_id % UINT64(20) = UINT64(0))
INTO ysb1kMapChecksum;
----
14236360, 35170842947

# Query 6: Filter and Map 50% selectivity - calculate engagement score for odd campaigns
SELECT user_id, (page_id + ad_type) * UINT64(10) AS click_score
FROM (SELECT user_id, page_id, ad_type FROM ysb1k WHERE campaign_id % UINT64(2) = UINT64(1))
INTO ysb1kMapChecksum;
----
14236360, 35170842947

# Query 7: Simple Windowed Aggregation - Count impressions by campaign
SELECT
    start,
    end,
    campaign_id,
    COUNT(user_id) AS impression_count
FROM ysb10k
GROUP BY campaign_id
WINDOW TUMBLING(current_ms, SIZE 30 SEC)
INTO campaignStatsChecksum;
----
14236360, 35170842947

# Query 8: Aggregation + Filter - Count high-value impressions
SELECT
    start,
    end,
    campaign_id,
    COUNT(user_id) AS high_value_count
FROM ysb10k
WHERE user_id > UINT64(900000)
GROUP BY campaign_id
WINDOW TUMBLING(current_ms, SIZE 10000 MS)
INTO highValueCampaignChecksum;
----
14236360, 35170842947

# Query 9: Aggregation + Map - Calculate engagement metrics
SELECT
    campaign_id,
    COUNT(user_id) AS impression_count,
    AVG(user_id % UINT64(100)) AS avg_engagement
FROM ysb10k
GROUP BY campaign_id
WINDOW TUMBLING(current_ms, SIZE 10000 MS)
INTO campaignEngagementChecksum;
----
14236360, 35170842947

# Query 10: Aggregation + Filter + Map - Calculate normalized scores for filtered campaigns
SELECT
    campaign_id,
    SUM(user_id) / COUNT(user_id) AS normalized_score
FROM ysb10k
WHERE page_id > UINT64(500)
GROUP BY campaign_id
WINDOW TUMBLING(current_ms, SIZE 10000)
INTO normalizedCampaignChecksum;
----
14236360, 35170842947

# Query 11: Multi-column operation (less columnar advantage)
SELECT
    campaign_id,
    SUM(user_id + page_id + ad_type) AS combined_score
FROM ysb10k
GROUP BY campaign_id
WINDOW TUMBLING(current_ms, SIZE 10000)
INTO normalizedCampaignChecksum;
----
14236360, 35170842947

SELECT user_id + UINT64(2) AS col1 FROM (SELECT * FROM ysb1k WHERE user_id % UINT64(2) = UINT64(0)) INTO ysb1kSum;
----
14236360, 35170842947

SELECT col1 FROM (SELECT user_id + UINT64(2) AS col1 FROM ysb1k) WHERE col1 % UINT64(2) = UINT64(0) INTO ysb1kSum;
----
14236360, 35170842947