# name: inference/smart-grid.test
# description: Smart Grid dataset experiments
# groups: [Inference]

Source smartGridSource UINT64 timestamp FLOAT64 value UINT64 property UINT64 plug_id UINT64 household_id UINT64 house_id FILE
TESTDATA/large/smartgrid/smartgrid-data-plug-13.csv

SINK smartGridVarsizedChecksum TYPE Checksum VARSIZED loadNext10Sec

MODEL standardScaler32 TESTDATA/model/scaler_fp32.onnx
UINT64 FLOAT64 FLOAT64 FLOAT64 FLOAT64
FLOAT32 count_sc FLOAT32 avg_sc FLOAT32 median_sc FLOAT32 min_sc FLOAT32 max_sc
BATCH_SIZE 1
CACHE NONE SIZE 1

MODEL lstm_none TESTDATA/model/smart-grid-lstm.onnx
VARSIZED
VARSIZED loadNext10Sec
BATCH_SIZE 1
CACHE NONE SIZE 1

SELECT loadNext10Sec
FROM (
    SELECT INFER_MODEL(lstm_none, (featuresScaledVarsized))
    FROM (
        SELECT
            CONCAT(value_count_array,
                CONCAT(value_avg_array,
                    CONCAT(value_median_array,
                        CONCAT(value_min_array, value_max_array)
                    )
                )
            ) AS featuresScaledVarsized
        FROM (
            SELECT
                start,
                ARRAY_AGG(count_sc) AS value_count_array,
                ARRAY_AGG(avg_sc) AS value_avg_array,
                ARRAY_AGG(median_sc) AS value_median_array,
                ARRAY_AGG(min_sc) AS value_min_array,
                ARRAY_AGG(max_sc) AS value_max_array
            FROM (
                SELECT INFER_MODEL(standardScaler32, (value_count, value_avg, value_median, value_min, value_max))
                FROM (
                    SELECT
                        start,
                        COUNT(value) AS value_count,
                        AVG(value) AS value_avg,
                        MEDIAN(value) AS value_median,
                        MIN(value) AS value_min,
                        MAX(value) AS value_max
                    FROM smartGridSource
                    WHERE property == UINT64(1)
                    WINDOW TUMBLING(timestamp, SIZE 1000 ms)
                )
            )
            WINDOW SLIDING(start, SIZE 60000 ms, ADVANCE BY 1000 ms)
        )
    )
)
INTO smartGridVarsizedChecksum
----

MODEL lstm_2q TESTDATA/model/smart-grid-lstm.onnx
VARSIZED
VARSIZED loadNext10Sec
BATCH_SIZE 1
CACHE 2Q SIZE 4096

SELECT loadNext10Sec
FROM (
    SELECT INFER_MODEL(lstm_2q, (featuresScaledVarsized))
    FROM (
        SELECT
            CONCAT(value_count_array,
                CONCAT(value_avg_array,
                    CONCAT(value_median_array,
                        CONCAT(value_min_array, value_max_array)
                    )
                )
            ) AS featuresScaledVarsized
        FROM (
            SELECT
                start,
                ARRAY_AGG(count_sc) AS value_count_array,
                ARRAY_AGG(avg_sc) AS value_avg_array,
                ARRAY_AGG(median_sc) AS value_median_array,
                ARRAY_AGG(min_sc) AS value_min_array,
                ARRAY_AGG(max_sc) AS value_max_array
            FROM (
                SELECT INFER_MODEL(standardScaler32, (value_count, value_avg, value_median, value_min, value_max))
                FROM (
                    SELECT
                        start,
                        COUNT(value) AS value_count,
                        AVG(value) AS value_avg,
                        MEDIAN(value) AS value_median,
                        MIN(value) AS value_min,
                        MAX(value) AS value_max
                    FROM smartGridSource
                    WHERE property == UINT64(1)
                    WINDOW TUMBLING(timestamp, SIZE 1000 ms)
                )
            )
            WINDOW SLIDING(start, SIZE 60000 ms, ADVANCE BY 1000 ms)
        )
    )
)
INTO smartGridVarsizedChecksum
----

MODEL lstm_fifo TESTDATA/model/smart-grid-lstm.onnx
VARSIZED
VARSIZED loadNext10Sec
BATCH_SIZE 1
CACHE FIFO SIZE 4096

SELECT loadNext10Sec
FROM (
    SELECT INFER_MODEL(lstm_fifo, (featuresScaledVarsized))
    FROM (
        SELECT
            CONCAT(value_count_array,
                CONCAT(value_avg_array,
                    CONCAT(value_median_array,
                        CONCAT(value_min_array, value_max_array)
                    )
                )
            ) AS featuresScaledVarsized
        FROM (
            SELECT
                start,
                ARRAY_AGG(count_sc) AS value_count_array,
                ARRAY_AGG(avg_sc) AS value_avg_array,
                ARRAY_AGG(median_sc) AS value_median_array,
                ARRAY_AGG(min_sc) AS value_min_array,
                ARRAY_AGG(max_sc) AS value_max_array
            FROM (
                SELECT INFER_MODEL(standardScaler32, (value_count, value_avg, value_median, value_min, value_max))
                FROM (
                    SELECT
                        start,
                        COUNT(value) AS value_count,
                        AVG(value) AS value_avg,
                        MEDIAN(value) AS value_median,
                        MIN(value) AS value_min,
                        MAX(value) AS value_max
                    FROM smartGridSource
                    WHERE property == UINT64(1)
                    WINDOW TUMBLING(timestamp, SIZE 1000 ms)
                )
            )
            WINDOW SLIDING(start, SIZE 60000 ms, ADVANCE BY 1000 ms)
        )
    )
)
INTO smartGridVarsizedChecksum
----

MODEL lstm_lfu TESTDATA/model/smart-grid-lstm.onnx
VARSIZED
VARSIZED loadNext10Sec
BATCH_SIZE 1
CACHE LFU SIZE 4096

SELECT loadNext10Sec
FROM (
    SELECT INFER_MODEL(lstm_lfu, (featuresScaledVarsized))
    FROM (
        SELECT
            CONCAT(value_count_array,
                CONCAT(value_avg_array,
                    CONCAT(value_median_array,
                        CONCAT(value_min_array, value_max_array)
                    )
                )
            ) AS featuresScaledVarsized
        FROM (
            SELECT
                start,
                ARRAY_AGG(count_sc) AS value_count_array,
                ARRAY_AGG(avg_sc) AS value_avg_array,
                ARRAY_AGG(median_sc) AS value_median_array,
                ARRAY_AGG(min_sc) AS value_min_array,
                ARRAY_AGG(max_sc) AS value_max_array
            FROM (
                SELECT INFER_MODEL(standardScaler32, (value_count, value_avg, value_median, value_min, value_max))
                FROM (
                    SELECT
                        start,
                        COUNT(value) AS value_count,
                        AVG(value) AS value_avg,
                        MEDIAN(value) AS value_median,
                        MIN(value) AS value_min,
                        MAX(value) AS value_max
                    FROM smartGridSource
                    WHERE property == UINT64(1)
                    WINDOW TUMBLING(timestamp, SIZE 1000 ms)
                )
            )
            WINDOW SLIDING(start, SIZE 60000 ms, ADVANCE BY 1000 ms)
        )
    )
)
INTO smartGridVarsizedChecksum
----

MODEL lstm_lru TESTDATA/model/smart-grid-lstm.onnx
VARSIZED
VARSIZED loadNext10Sec
BATCH_SIZE 1
CACHE LRU SIZE 4096

SELECT loadNext10Sec
FROM (
    SELECT INFER_MODEL(lstm_lru, (featuresScaledVarsized))
    FROM (
        SELECT
            CONCAT(value_count_array,
                CONCAT(value_avg_array,
                    CONCAT(value_median_array,
                        CONCAT(value_min_array, value_max_array)
                    )
                )
            ) AS featuresScaledVarsized
        FROM (
            SELECT
                start,
                ARRAY_AGG(count_sc) AS value_count_array,
                ARRAY_AGG(avg_sc) AS value_avg_array,
                ARRAY_AGG(median_sc) AS value_median_array,
                ARRAY_AGG(min_sc) AS value_min_array,
                ARRAY_AGG(max_sc) AS value_max_array
            FROM (
                SELECT INFER_MODEL(standardScaler32, (value_count, value_avg, value_median, value_min, value_max))
                FROM (
                    SELECT
                        start,
                        COUNT(value) AS value_count,
                        AVG(value) AS value_avg,
                        MEDIAN(value) AS value_median,
                        MIN(value) AS value_min,
                        MAX(value) AS value_max
                    FROM smartGridSource
                    WHERE property == UINT64(1)
                    WINDOW TUMBLING(timestamp, SIZE 1000 ms)
                )
            )
            WINDOW SLIDING(start, SIZE 60000 ms, ADVANCE BY 1000 ms)
        )
    )
)
INTO smartGridVarsizedChecksum
----

MODEL lstm_second_chance TESTDATA/model/smart-grid-lstm.onnx
VARSIZED
VARSIZED loadNext10Sec
BATCH_SIZE 1
CACHE SecondChance SIZE 4096

SELECT loadNext10Sec
FROM (
    SELECT INFER_MODEL(lstm_second_chance, (featuresScaledVarsized))
    FROM (
        SELECT
            CONCAT(value_count_array,
                CONCAT(value_avg_array,
                    CONCAT(value_median_array,
                        CONCAT(value_min_array, value_max_array)
                    )
                )
            ) AS featuresScaledVarsized
        FROM (
            SELECT
                start,
                ARRAY_AGG(count_sc) AS value_count_array,
                ARRAY_AGG(avg_sc) AS value_avg_array,
                ARRAY_AGG(median_sc) AS value_median_array,
                ARRAY_AGG(min_sc) AS value_min_array,
                ARRAY_AGG(max_sc) AS value_max_array
            FROM (
                SELECT INFER_MODEL(standardScaler32, (value_count, value_avg, value_median, value_min, value_max))
                FROM (
                    SELECT
                        start,
                        COUNT(value) AS value_count,
                        AVG(value) AS value_avg,
                        MEDIAN(value) AS value_median,
                        MIN(value) AS value_min,
                        MAX(value) AS value_max
                    FROM smartGridSource
                    WHERE property == UINT64(1)
                    WINDOW TUMBLING(timestamp, SIZE 1000 ms)
                )
            )
            WINDOW SLIDING(start, SIZE 60000 ms, ADVANCE BY 1000 ms)
        )
    )
)
INTO smartGridVarsizedChecksum
----
