# name: inference/iris.test
# description: Simple Iris inference
# groups: [Inference]

### Model Inference with multiple Parameters
### Model is registered with 4 input parameters and three output parameters

Source streamFloat FLOAT32 p1 FLOAT32 p2 FLOAT32 p3 FLOAT32 p4 FILE
TESTDATA/small/iris.csv

Source streamFloatCache FLOAT32 p1 FLOAT32 p2 FLOAT32 p3 FLOAT32 p4 FILE
TESTDATA/small/irisCache.csv

Source streamDiff FLOAT32 p1 FLOAT32 p2 FLOAT32 p3 FLOAT32 p4 INLINE
1.1,1.2,1.3,1.4
2.1,2.2,2.3,2.4
3.1,3.2,3.3,3.4
4.1,4.2,4.3,4.4

Source streamIdent FLOAT32 p1 FLOAT32 p2 FLOAT32 p3 FLOAT32 p4 INLINE
1.1,1.2,1.3,1.4
1.1,1.2,1.3,1.4
1.1,1.2,1.3,1.4
1.1,1.2,1.3,1.4

SINK classificationThreeSeparate FLOAT32 setosa FLOAT32 versicolor FLOAT32 virginica
SINK irisChecksum TYPE Checksum FLOAT32 setosa FLOAT32 versicolor FLOAT32 virginica

MODEL irisCache TESTDATA/model/model.onnx
FLOAT32 FLOAT32 FLOAT32 FLOAT32
FLOAT32 setosa FLOAT32 versicolor FLOAT32 virginica
BATCH_SIZE 1

SELECT setosa, versicolor, virginica
FROM (SELECT INFER_MODEL(irisCache, (p1,p2,p3,p4)) FROM streamDiff)
INTO classificationThreeSeparate
----
0.184111,0.288652,0.527237
0.087036,0.243997,0.668967
0.037535,0.188152,0.774314
0.015307,0.137196,0.847498

SELECT setosa, versicolor, virginica
FROM (SELECT INFER_MODEL(irisCache, (p1,p2,p3,p4)) FROM streamIdent)
INTO classificationThreeSeparate
----
0.184111,0.288652,0.527237
0.184111,0.288652,0.527237
0.184111,0.288652,0.527237
0.184111,0.288652,0.527237

MODEL iris4 TESTDATA/model/model.onnx
FLOAT32 FLOAT32 FLOAT32 FLOAT32
FLOAT32 setosa FLOAT32 versicolor FLOAT32 virginica
BATCH_SIZE 32

SELECT setosa, versicolor, virginica
FROM (SELECT INFER_MODEL(iris4, (p1,p2,p3,p4)) FROM streamFloatCache)
INTO irisChecksum
----
1023,1352145

SELECT setosa, versicolor, virginica
FROM (SELECT INFER_MODEL(iris4, (p1,p2,p3,p4)) FROM streamFloat)
INTO classificationThreeSeparate
----
0.857163,0.129977,0.01286
0.881335,0.110331,0.008334
0.921536,0.074672,0.003792
0.879475,0.112063,0.008462
0.946717,0.051443,0.00184
0.888224,0.103913,0.007863
0.898816,0.094172,0.007012
0.864633,0.124355,0.011012
0.929244,0.067405,0.003351
0.909871,0.084877,0.005252
0.91703,0.0792,0.00377
0.907092,0.087611,0.005297
0.911246,0.083624,0.005129
0.901893,0.092844,0.005262
0.883699,0.107563,0.008738
0.899732,0.09408,0.006187
0.88669,0.105214,0.008096
0.897475,0.094482,0.008044
0.950295,0.048001,0.001704
0.934699,0.062695,0.002606
0.916293,0.079154,0.004553
0.858424,0.130254,0.011322
0.854698,0.133633,0.011669
0.909342,0.085666,0.004992
0.887866,0.105542,0.006592
0.901089,0.092947,0.005964
0.915062,0.079702,0.005237
0.85773,0.131591,0.010679
0.923333,0.07301,0.003657
0.937533,0.059916,0.002551
0.881335,0.110331,0.008334
0.919551,0.075759,0.00469
0.934783,0.062293,0.002924
0.881335,0.110331,0.008334
0.879037,0.110977,0.009986
0.904365,0.090008,0.005627
0.864163,0.126731,0.009106
0.881347,0.109737,0.008916
0.903216,0.091309,0.005475
0.884579,0.10678,0.008642
0.816113,0.168051,0.015836
0.856106,0.13275,0.011143
0.88094,0.110884,0.008177
0.910452,0.084612,0.004935
0.917701,0.078126,0.004174
0.906208,0.08808,0.005712
0.058564,0.669232,0.272204
0.057593,0.625603,0.316804
0.913239,0.081618,0.005143
0.823045,0.157875,0.01908
0.883362,0.107332,0.009305
0.872453,0.118257,0.00929
0.071187,0.539932,0.38888
0.063455,0.595955,0.34059
0.06037,0.597134,0.342496
0.024664,0.50871,0.466627
0.032733,0.598917,0.36835
0.041645,0.514533,0.443822
0.035052,0.570178,0.39477
0.026924,0.492881,0.480195
0.019392,0.46207,0.518538
0.071361,0.589658,0.33898
0.019008,0.454676,0.526317
0.094935,0.641157,0.263908
0.152031,0.618529,0.22944
0.079127,0.669814,0.251059
0.027763,0.486481,0.485756
0.067996,0.608326,0.323679
0.038076,0.5756,0.386324
0.13635,0.586182,0.277468
0.044632,0.614631,0.340737
0.058149,0.536392,0.405459
0.029685,0.57662,0.393695
0.019149,0.5095,0.471351
0.033614,0.533545,0.432841
0.16339,0.620222,0.216389
0.011584,0.41589,0.572527
0.024534,0.51415,0.461316
0.070475,0.642528,0.286997
0.068814,0.651777,0.279409
0.023868,0.455099,0.521033
0.051306,0.589331,0.359363
0.042986,0.614504,0.342511
0.031499,0.538398,0.430103
0.069227,0.592368,0.338405
0.050357,0.540778,0.408864
0.024756,0.467906,0.507338
0.033631,0.547985,0.418384
0.06983,0.599439,0.33073
0.132973,0.588195,0.278832
0.043066,0.536693,0.42024
0.063161,0.595096,0.341743
0.074551,0.584046,0.341403
0.093685,0.605289,0.301025
0.09178,0.622394,0.285826
0.006624,0.335759,0.657617
0.055435,0.575616,0.368949
0.062493,0.619985,0.317522
0.238111,0.56608,0.195809
0.061797,0.583219,0.354983
0.001539,0.224705,0.773756
0.002786,0.302715,0.694498
0.013956,0.449566,0.536478
0.004884,0.315832,0.679284
0.005354,0.348416,0.64623
0.004076,0.254826,0.741098
0.003909,0.249691,0.746399
0.006877,0.349114,0.644009
0.001074,0.178385,0.820542
0.00467,0.279391,0.71594
0.002624,0.29179,0.705586
0.002836,0.265977,0.731187
0.004878,0.332188,0.662933
0.001483,0.282445,0.716072
0.000189,0.119157,0.880655
0.005054,0.299988,0.694958
0.001824,0.227566,0.77061
0.000709,0.203406,0.795886
0.008152,0.287772,0.704076
0.001225,0.240094,0.758681
0.004245,0.325197,0.670558
0.00335,0.337709,0.65894
0.015841,0.441887,0.542272
0.014385,0.429362,0.556253
0.004033,0.321536,0.674431
0.006779,0.303552,0.689669
0.000501,0.182146,0.817353
0.012277,0.415555,0.572168
0.002174,0.233696,0.76413
0.010057,0.407506,0.582437
0.002092,0.2364,0.761508
0.002444,0.310162,0.687394
0.00231,0.241628,0.756063
0.004831,0.381099,0.61407
0.001863,0.276996,0.721141
0.004076,0.411041,0.584883
0.003586,0.278743,0.717671
0.005007,0.331592,0.663401
0.016689,0.440291,0.543021
0.008242,0.406165,0.585593
0.003375,0.28815,0.708475
0.009006,0.392634,0.59836
0.007385,0.348735,0.64388
0.008951,0.391513,0.599536
0.003632,0.294218,0.70215
0.014778,0.467748,0.517474
0.00467,0.279391,0.71594
0.002242,0.259725,0.738032
0.005688,0.322273,0.672039
0.007619,0.344656,0.647725

## We can filter on both input and output fields

SELECT setosa, versicolor, virginica
FROM (SELECT INFER_MODEL(iris4, (p1,p2,p3,p4)) FROM streamFloat WHERE p1 < FLOAT32(5.0))
WHERE setosa < FLOAT32(0.9)
INTO classificationThreeSeparate
----
0.888224,0.103913,0.007863
0.898816,0.094172,0.007012
0.864633,0.124355,0.011012
0.883699,0.107563,0.008738
0.857163,0.129977,0.01286
0.881335,0.110331,0.008334
0.879475,0.112063,0.008462
0.88669,0.105214,0.008096
0.897475,0.094482,0.008044
0.816113,0.168051,0.015836
0.858424,0.130254,0.011322
0.854698,0.133633,0.011669
0.881335,0.110331,0.008334
0.881335,0.110331,0.008334
0.879037,0.110977,0.009986
0.823045,0.157875,0.01908
0.883362,0.107332,0.009305
0.881347,0.109737,0.008916
0.884579,0.10678,0.008642
0.13635,0.586182,0.277468
0.008152,0.287772,0.704076

## With a custom function we can recreate the label

SINK classification VARSIZED streamFloat$flower

SELECT iris_label(setosa, versicolor, virginica) as flower
FROM (SELECT INFER_MODEL(iris4, (p1,p2,p3,p4)) FROM streamFloat)
INTO classification
----
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
setosa
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
virginica
versicolor
virginica
versicolor
virginica
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
virginica
virginica
versicolor
versicolor
versicolor
versicolor
versicolor
virginica
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
versicolor
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica
virginica

## Model Inference with VarSized input and and multiple output parameters
Source streamVarsized VARSIZED data INLINE
aaaaaaaaaaaaaaaa

Sink classificationVarsized VARSIZED streamVarsized$data VARSIZED streamVarsized$flower

MODEL iris TESTDATA/model/iris.onnx
VARSIZED
FLOAT32 setosa FLOAT32 versicolor FLOAT32 virginica
BATCH_SIZE 1

SELECT data, iris_label(setosa, versicolor, virginica) as flower
FROM (SELECT INFER_MODEL(iris, (data)) FROM streamVarsized)
INTO classificationVarsized
----
aaaaaaaaaaaaaaaa,virginica


## ArgMax function on output vector
Sink classificationVarsizedArgMax UINT64 streamVarsized$index

MODEL iris_varsized TESTDATA/model/iris.onnx
VARSIZED
VARSIZED species_vector
BATCH_SIZE 1

SELECT ArgMax(species_vector) as index
FROM (SELECT INFER_MODEL(iris_varsized, (data)) FROM streamVarsized)
INTO classificationVarsizedArgMax
----
2
