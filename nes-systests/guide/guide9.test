# name: guide/guide9.test
# description: Count and average response time per endpoint in tumbling windows
# groups: [Window, Aggregation, Tumbling, Count, Avg]

CREATE LOGICAL SOURCE api_requests(
    endpoint VARSIZED NOT NULL,
    response_time FLOAT64 NOT NULL,
    ts INT64 NOT NULL
);

CREATE PHYSICAL SOURCE FOR api_requests TYPE File;
ATTACH INLINE
/login,120.0,10000
/login,100.0,20000
/search,200.0,30000
/login,80.0,40000
/search,220.0,50000
/login,90.0,310000
/search,210.0,320000
/search,190.0,330000

CREATE SINK sink(
    `API_REQUESTS$RESPONSE_TIME_COUNT` UINT64 NOT NULL,
    `API_REQUESTS$RESPONSE_TIME_AVG`   FLOAT64 NOT NULL
) TYPE File;

SELECT
    COUNT(response_time),
    AVG(response_time)
FROM api_requests
GROUP BY endpoint
WINDOW TUMBLING(ts, SIZE 5 MINUTES)
INTO sink;
----
1,90.0
2,200.0
2,210.0
3,100.0
