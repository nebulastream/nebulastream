# name: sources/ODBC.test
# description: Simple tests for the ODBC source
# groups: [TestContainer]
CREATE LOGICAL SOURCE odbc_source(LabVal_ID INT32, mlife_FallNr INT32, Zeitpunkt UINT64, GruppenNr INT32, Gruppe INT32, Bez VARSIZED, Wert VARSIZED, Einheit VARSIZED, Wertebereich VARSIZED, SampleNr VARSIZED, TSFail UINT64, TSLog UINT64, Lab_ID INT32);

CREATE PHYSICAL SOURCE FOR odbc_source TYPE ODBC SET("Native" AS PARSER.`TYPE`, "SELECT LabVal_ID, mlife_FallNr, Zeitpunkt, GruppenNr, Gruppe, Bez, Wert, Einheit, Wertebereich, SampleNr, TSFail, TSLog, Lab_ID FROM dbo.v_Labor_null" AS `SOURCE`.query, "sql_server" AS `SOURCE`.host, "1433" AS `SOURCE`.PORT, "master" AS `SOURCE`.database, "sa" AS `SOURCE`.username, "samplePassword1!" AS `SOURCE`.password, "ODBC Driver 18 for SQL Server" AS `SOURCE`.driver, "dbo.v_Labor_null" AS `SOURCE`.sync_table, "1000" AS `SOURCE`.poll_interval_ms, "true" AS `SOURCE`.trust_server_certificate);

SELECT LabVal_ID, mlife_FallNr, Zeitpunkt, GruppenNr, Gruppe, Bez, Wert, Einheit, Wertebereich, SampleNr, TSFail, TSLog, Lab_ID FROM odbc_source INTO File();
----
1 1001 1705307400 1 5 Hämoglobin 14.5 g/dL 12-16 S001 1705305600 1705309200 101
2 1001 1705307400 1 5 Leukozyten 7.2 10^9/L 4-10 S001 1705305600 1705309200 101
3 1002 1705310100 2 5 Glucose 95 mg/dL 70-110 S002 1705308300 1705311000 102
4 1002 1705310100 2 5 Kreatinin ?.9 mg/dL  0.6-1.2 S002 1705308300 1705311000 102
5 1003 1705312800 1 5 Thrombozyten K 10^9/L 150-400 S003 1705311000 1705313700 103

SELECT LabVal_ID, mlife_FallNr, Zeitpunkt, GruppenNr, Gruppe, Bez, VarSizedToDouble(Wert) AS doubleWert, Einheit, Wertebereich, SampleNr, TSFail, TSLog, Lab_ID FROM odbc_source INTO File();
----
1 1001 1705307400 1 5 Hämoglobin 14.5 g/dL 12-16 S001 1705305600 1705309200 101
2 1001 1705307400 1 5 Leukozyten 7.2 10^9/L 4-10 S001 1705305600 1705309200 101
3 1002 1705310100 2 5 Glucose 95 mg/dL 70-110 S002 1705308300 1705311000 102
4 1002 1705310100 2 5 Kreatinin 0.9 mg/dL  0.6-1.2 S002 1705308300 1705311000 102
5 1003 1705312800 1 5 Thrombozyten nan 10^9/L 150-400 S003 1705311000 1705313700 103
