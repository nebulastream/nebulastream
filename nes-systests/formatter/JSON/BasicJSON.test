# name: JSON.test
# description: tests general input formatter behavior
# groups: [Formatter, JSON]

CREATE LOGICAL SOURCE jsonStream(KEY UINT64 NOT NULL, value UINT64 NOT NULL, name VARSIZED NOT NULL);
CREATE PHYSICAL SOURCE FOR jsonStream TYPE File SET("JSON" AS PARSER.`TYPE`);
ATTACH INLINE
{"KEY":1, "VALUE":1, "NAME":"john"}
{"KEY":1, "VALUE":2, "NAME":"max"}

CREATE LOGICAL SOURCE jsonStreamWrongDataTypes(key UINT64 NOT NULL, value UINT64 NOT NULL, name VARSIZED NOT NULL);
CREATE PHYSICAL SOURCE FOR jsonStreamWrongDataTypes TYPE File SET("JSON" AS PARSER.`TYPE`);
ATTACH INLINE
{"KEY":1.0, "VALUE":1, "NAME":"john"}
{"KEY":1, "VALUE":2, "NAME":"max"}

CREATE LOGICAL SOURCE jsonStreamWrongDataTypesWithObject(key UINT64 NOT NULL, value UINT64 NOT NULL, name VARSIZED NOT NULL);
CREATE PHYSICAL SOURCE FOR jsonStreamWrongDataTypesWithObject TYPE File SET("JSON" AS PARSER.`TYPE`);
ATTACH INLINE
{"KEY":{"value": 1}, "VALUE":1, "NAME":"john"}
{"KEY":1, "VALUE":2, "NAME":"max"}

CREATE LOGICAL SOURCE jsonStreamWrongFieldName(key UINT64 NOT NULL, value UINT64 NOT NULL, name VARSIZED NOT NULL);
CREATE PHYSICAL SOURCE FOR jsonStreamWrongFieldName TYPE File SET("JSON" AS PARSER.`TYPE`);
ATTACH INLINE
{"WRONG_NAME":1, "VALUE":1, "NAME":"john"}
{"WRONG_NAME":1, "VALUE":2, "NAME":"max"}

CREATE LOGICAL SOURCE MissingKeyFronJSONStream(key UINT64 NOT NULL, value UINT64 NOT NULL, name VARSIZED NOT NULL);
CREATE PHYSICAL SOURCE FOR MissingKeyFronJSONStream TYPE File SET("JSON" AS PARSER.`TYPE`);
ATTACH INLINE
{"KEY":1, "VALUE":1, "NAME":"john"}
{"KEY":1, "VALUE":2 }

CREATE LOGICAL SOURCE ExtraKeyJson(key UINT64 NOT NULL, value UINT64 NOT NULL, name VARSIZED NOT NULL);
CREATE PHYSICAL SOURCE FOR ExtraKeyJson TYPE File SET("JSON" AS PARSER.`TYPE`);
ATTACH INLINE
{"KEY":1, "VALUE":1, "NAME":"john"}
{"KEY":1, "VALUE":2, "NAME": "max", "EXTRA_KEY": 1 }

CREATE LOGICAL SOURCE ExtraKeyObjectJson(key UINT64 NOT NULL, value UINT64 NOT NULL, name VARSIZED NOT NULL);
CREATE PHYSICAL SOURCE FOR ExtraKeyObjectJson TYPE File SET("JSON" AS PARSER.`TYPE`);
ATTACH INLINE
{"KEY":1, "VALUE":1, "NAME":"john"}
{"KEY":1, "VALUE":2, "NAME": "max", "EXTRA_KEY": {"KEY": 2}}

CREATE SINK keySink(jsonStream.key UINT64 NOT NULL) TYPE File;
CREATE SINK valueSink(jsonStream.value UINT64 NOT NULL) TYPE File;
CREATE SINK nameSink(jsonStream.name VARSIZED NOT NULL) TYPE File;
CREATE SINK allFieldsSink(jsonStream.key UINT64 NOT NULL, jsonStream.value UINT64 NOT NULL, jsonStream.name VARSIZED NOT NULL) TYPE File;
CREATE SINK allFieldsWrongFieldNameSink(jsonStreamWrongFieldName.key UINT64 NOT NULL, jsonStreamWrongFieldName.value UINT64 NOT NULL, jsonStreamWrongFieldName.name VARSIZED NOT NULL) TYPE File;
CREATE SINK allFieldsWrongDataTypeSink(jsonStreamWrongDataTypes.key UINT64 NOT NULL, jsonStreamWrongDataTypes.value UINT64 NOT NULL, jsonStreamWrongDataTypes.name VARSIZED NOT NULL) TYPE File;

SELECT KEY FROM jsonStream INTO keySink;
----
1
1

SELECT value FROM jsonStream INTO valueSink;
----
1
2

SELECT name FROM jsonStream INTO nameSink;
----
john
max

SELECT * FROM jsonStream INTO allFieldsSink;
----
1,1,john
1,2,max

SELECT * FROM jsonStreamWrongDataTypes INTO allFieldsWrongDataTypeSink;
----
ERROR 4005

SELECT * FROM jsonStreamWrongDataTypesWithObject INTO File();
----
ERROR 4005

SELECT * FROM jsonStreamWrongFieldName INTO allFieldsWrongFieldNameSink;
----
ERROR 2004

SELECT * FROM MissingKeyFronJSONStream INTO Checksum();
----
ERROR 2004

SELECT * FROM ExtraKeyJson INTO File();
----
1,1,john
1,2,max

SELECT * FROM ExtraKeyObjectJson INTO File();
----
1,1,john
1,2,max
