# description: Regression test for issue #788 - aggregation expression crash (bad_variant_access)
# groups: [regression]
#
# Aggregation functions like MEDIAN, SUM, etc. require a direct field access as their argument.
# Passing an arithmetic expression (e.g. MEDIAN(i8 + INT8(1))) previously caused a bad_variant_access crash.
# After the fix, this case throws InvalidQuerySyntax (error code 2000).
# Post-aggregation arithmetic (e.g. MEDIAN(i8) + FLOAT64(1)) is supported.

CREATE LOGICAL SOURCE stream(i8 INT8, ts UINT64);
CREATE PHYSICAL SOURCE FOR stream TYPE File;
ATTACH INLINE
1,100
2,125
3,150

CREATE SINK sinkAggOut(stream.start UINT64, stream.end UINT64, out FLOAT64) TYPE File;

# Arithmetic expression as aggregation argument (MEDIAN(i8 + INT8(1))) -- must give a clear error, not crash.
SELECT start, end, MEDIAN(i8 + INT8(1)) AS out FROM stream WINDOW TUMBLING(ts, size 100 ms) INTO sinkAggOut;
----
ERROR 2000

# Arithmetic expression after an aggregation argument -- must give a clear error, not crash.
SELECT start, end, MEDIAN(i8) + 1 AS out FROM stream WINDOW TUMBLING(ts, size 100 ms) INTO sinkAggOut;
----
ERROR 2000
