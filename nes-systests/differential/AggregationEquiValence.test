# name: differential/AggregationEquivalence.test
# description: Ensure differential queries agree for logically equivalent aggregation
# groups: [Differential, Aggregation]

Source stream UINT64 id UINT64 value UINT64 timestamp GENERATOR seed 1, max_runtime_ms 1000, stop_generator_when_sequence_finishes ALL
id SEQUENCE UINT64 1 5 1
value SEQUENCE UINT64 10 50 10
timestamp SEQUENCE UINT64 0 20000 5000

SINK sinkStream UINT64 stream$start UINT64 stream$end UINT64 stream$id UINT64 stream$sumValue

SELECT start, end, id, SUM(value) AS sumValue
FROM (
  SELECT id, start, SUM(value) AS value
  FROM stream
  GROUP BY id
  WINDOW TUMBLING (timestamp, size 5 sec)
)
GROUP BY id
WINDOW SLIDING (start, size 10 sec, advance by 5 sec)
INTO sinkStream;
====
SELECT start, end, id, SUM(value) AS sumValue
FROM stream
GROUP BY id
WINDOW SLIDING (timestamp, size 10 sec, advance by 5 sec)
INTO sinkStream;
