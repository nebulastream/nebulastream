# name: differential/SelectionEquivalence.test
# description: Ensure differential queries agree for logically equivalent selections
# groups: [Differential, Selection]

CREATE LOGICAL SOURCE stream(id UINT64 NOT NULL, value UINT64 NOT NULL, timestamp UINT64 NOT NULL);
CREATE PHYSICAL SOURCE FOR stream TYPE Generator SET(
    1 AS `SOURCE`.SEED,
    'ALL' as `SOURCE`.STOP_GENERATOR_WHEN_SEQUENCE_FINISHES,
    'SEQUENCE UINT64 1 2001 10, SEQUENCE UINT64 0 1200 6, SEQUENCE UINT64 0 1000000 5000' AS `SOURCE`.GENERATOR_SCHEMA
);

CREATE SINK selectionSink(out_id UINT64 NOT NULL, out_value UINT64 NOT NULL, out_timestamp UINT64 NOT NULL) TYPE File;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp FROM stream WHERE value >= UINT64(10) INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp FROM stream WHERE NOT (value < UINT64(10)) INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value >= UINT64(10) AND value <= UINT64(100)
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE NOT (value < UINT64(10) OR value > UINT64(100))
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value <= UINT64(20) OR value >= UINT64(80)
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE NOT (value > UINT64(20) AND value < UINT64(80))
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value != UINT64(42)
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value < UINT64(42) OR value > UINT64(42)
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value >= UINT64(10) AND (id >= UINT64(1000) OR timestamp >= UINT64(1000000000))
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE (value >= UINT64(10) AND id >= UINT64(1000))
   OR (value >= UINT64(10) AND timestamp >= UINT64(1000000000))
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE (value >= UINT64(10) AND value <= UINT64(50))
  AND (id >= UINT64(100) OR timestamp >= UINT64(1000000))
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE NOT (
    (value < UINT64(10) OR value > UINT64(50))
    OR (id < UINT64(100) AND timestamp < UINT64(1000000))
)
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value >= UINT64(90) OR (id >= UINT64(5) AND timestamp >= UINT64(100))
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE (value >= UINT64(90) OR id >= UINT64(5))
  AND (value >= UINT64(90) OR timestamp >= UINT64(100))
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value >= UINT64(10)
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE (value >= UINT64(10) AND id >= UINT64(100))
   OR (value >= UINT64(10) AND NOT (id >= UINT64(100)))
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value <= UINT64(50)
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value <= UINT64(50) OR (value <= UINT64(50) AND id >= UINT64(1))
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE (value >= UINT64(10) AND id >= UINT64(100))
   OR (value < UINT64(10) AND timestamp >= UINT64(1000))
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE (value >= UINT64(10) AND id >= UINT64(100))
   OR (value < UINT64(10) AND timestamp >= UINT64(1000))
   OR (id >= UINT64(100) AND timestamp >= UINT64(1000))
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE id <= timestamp
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE NOT (id > timestamp)
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE id != value
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE id < value OR id > value
INTO selectionSink;


SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE (value >= UINT64(100) AND value <= UINT64(200))
   OR (id >= UINT64(1000) AND id <= UINT64(2000))
   OR (timestamp >= UINT64(10000) AND timestamp <= UINT64(20000))
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE NOT (
    (value < UINT64(100) OR value > UINT64(200)) AND
    (id < UINT64(1000) OR id > UINT64(2000)) AND
    (timestamp < UINT64(10000) OR timestamp > UINT64(20000))
)
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value < UINT64(10) AND value >= UINT64(10)
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE id != id
INTO selectionSink;

SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE id = id
INTO selectionSink;
====
SELECT id AS out_id, value AS out_value, timestamp AS out_timestamp
FROM stream
WHERE value >= UINT64(0)
INTO selectionSink;
