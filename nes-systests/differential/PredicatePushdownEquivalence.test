# name: differential/PredicatePushdownEquivalence.test
# description: Verify predicate pushdown preserves query semantics. Each pair separated by ==== must produce identical results: the left form has a filter above a subquery projection (the form that triggers pushdown), the right form is the equivalent direct query (which does not require pushdown).
# groups: [Differential, Selection, PredicatePushdown, CompilationIntensive]

CREATE LOGICAL SOURCE stream(id UINT64, value UINT64, timestamp UINT64);
CREATE PHYSICAL SOURCE FOR stream TYPE Generator SET(
    1 AS `SOURCE`.SEED,
    'ALL' as `SOURCE`.STOP_GENERATOR_WHEN_SEQUENCE_FINISHES,
    'SEQUENCE UINT64 1 3 1, SEQUENCE UINT64 10 30 10, SEQUENCE UINT64 1000 1002 1' AS `SOURCE`.GENERATOR_SCHEMA
);

CREATE SINK selectionSink(out_id UINT64) TYPE File;
CREATE SINK selectionSink2(out_id UINT64, out_value UINT64) TYPE File;

# Filter on a column present in the subquery projection but absent from the outer SELECT:
# predicate pushdown must move the selection below the inner projection.
SELECT id AS out_id FROM (SELECT id, value FROM stream) WHERE value >= UINT64(20) INTO selectionSink;
====
SELECT id AS out_id FROM stream WHERE value >= UINT64(20) INTO selectionSink;

# AND predicate pushed below a subquery projection.
SELECT id AS out_id FROM (SELECT id, value FROM stream) WHERE value >= UINT64(20) AND value <= UINT64(20) INTO selectionSink;
====
SELECT id AS out_id FROM stream WHERE value >= UINT64(20) AND value <= UINT64(20) INTO selectionSink;

# Filter pushed through two levels of projections.
SELECT id AS out_id FROM (SELECT id FROM (SELECT id, value FROM stream) WHERE value >= UINT64(30)) INTO selectionSink;
====
SELECT id AS out_id FROM stream WHERE value >= UINT64(30) INTO selectionSink;

# Filter on a non-output field: the predicate references `value` even though only `id` is projected.
# Pushdown must preserve the predicate even though `value` is not in the outer projection.
SELECT id AS out_id, value AS out_value FROM (SELECT id, value FROM stream) WHERE value <= UINT64(20) INTO selectionSink2;
====
SELECT id AS out_id, value AS out_value FROM stream WHERE value <= UINT64(20) INTO selectionSink2;
