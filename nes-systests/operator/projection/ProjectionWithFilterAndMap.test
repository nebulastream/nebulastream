# name: projection/ProjectionWithFilterAndMap.test
# description: Simple map tests with an add function
# groups: [Projection, Filter, Map]

Source window UINT64 id UINT64 value UINT64 timestamp
1,1,1000
2,1,1001
3,1,1002
4,2,2000
5,19,19000
6,20,20000
7,21,21000

# 0: first filter on 'timestamp', then project on 'id'
SELECT id FROM window WHERE timestamp == 1002 INTO SINK
----
3

# 1: first filter on 'timestamp' and 'value', then project on 'id'
SELECT id FROM window WHERE timestamp == 1002 AND value == 1 INTO SINK
----
3

# 2: filter -> project [id]
SELECT id FROM window WHERE id == 1 INTO SINK
----
1

# 3: project -> filter -> map [id]
SELECT id * 2 AS id FROM window WHERE id == 1 INTO SINK
----
2

# It is not possible to write (without using a subquery):
#   SELECT id * 2 AS new_id FROM window WHERE new_id == 2
# this is in line with the SQL standard: https://dev.mysql.com/doc/refman/8.4/en/problems-with-alias.html
# 4: map -> filter -> project [id]
SELECT new_id FROM
    (SELECT id * 2 AS new_id FROM window)
WHERE new_id == 2 INTO SINK
----
2

# 5: filter -> map -> project [id -> new_id]
SELECT id * 2 AS new_id FROM window WHERE id == 1 INTO SINK
----
2

# 6: filter -> map ->  project [id, id * 2 -> new_id, value, timestamp]
SELECT id, id * 2 AS new_id, value, timestamp FROM window WHERE id == 1 INTO SINK
----
1 2 1 1000

# 7: filter -> map -> project -> map -> map [new_id -> id, value, timestamp]
SELECT id * 2 AS new_id, id, id AS value, id * 1000 AS timestamp FROM window WHERE id == 1 INTO SINK
----
2 1 1 1000
