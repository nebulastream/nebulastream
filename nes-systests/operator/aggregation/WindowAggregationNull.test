# name: window/WindowAggregationNull.test
# description: Test window aggregation with null values
# groups: [Aggregation, WindowOperators, NullHandling]

# Source definitions
CREATE LOGICAL SOURCE stream(ts UINT64 NOT NULL, id INT32 NOT NULL, value INT32);
CREATE PHYSICAL SOURCE FOR stream TYPE File;
ATTACH INLINE
0,0,0
20,1,3
50,0,1
100,0,2
150,1,
200,0,10
350,2,4
350,0,2
350,1,1
350,0,2
500,2,-1
520,0,11
530,0,

CREATE LOGICAL SOURCE stream2(ts UINT64 NOT NULL, id INT32, value INT32);
CREATE PHYSICAL SOURCE FOR stream2 TYPE File;
ATTACH INLINE
0,,
10,,1
20,1,2
30,1,3
40,3,
50,3,
1100,,
1110,,4
1120,1,5
1130,1,
1140,3,

CREATE LOGICAL SOURCE stream3(id UINT64 NOT NULL, value UINT64, timestamp UINT64 NOT NULL);
CREATE PHYSICAL SOURCE FOR stream3 TYPE File;
ATTACH INLINE
1,,2004
1,,3000


CREATE SINK sink0(stream.start UINT64 NOT NULL, stream.end UINT64 NOT NULL, stream.valueSum INT32) TYPE File;
CREATE SINK sink1(stream.start UINT64 NOT NULL, stream.end UINT64 NOT NULL, stream.valueSum INT32, stream.valueMax INT32, stream.valueMin INT32, stream.valueAvg FLOAT64, stream.valueMedian FLOAT64) TYPE File;
CREATE SINK sink2(stream2.start UINT64 NOT NULL, stream2.end UINT64 NOT NULL, stream2.id INT32, stream2.valueSum INT32, stream2.valueMin INT32, stream2.valueMax INT32, stream2.valueAvg FLOAT64, stream2.valueCount UINT64 NOT NULL, stream2.rowCount UINT64 NOT NULL) TYPE File;


# Checking if a sum over a tumbling window works with null values in the value field
# We expect NULLs to be ignored in value fields for SUM aggregation
SELECT start, end, SUM(value) as valueSum
FROM stream WINDOW TUMBLING(ts, size 100 ms)
INTO sink0;
----
0,100,4
100,200,NULL
200,300,10
300,400,9
500,600,NULL


# Checking if all aggregation function over a sliding window works with null values in the value field
SELECT start, end, SUM(value) AS valueSum, MAX(value) AS valueMax,
       MIN(value) AS valueMin, AVG(value) AS valueAvg, MEDIAN(value) as valueMedian
FROM stream WINDOW SLIDING(ts, size 100 ms, advance by 50 ms)
INTO sink1;
----
0,100,4,3,0,1.333333,1
50,150,3,2,1,1.5,1.5
100,200,NULL,NULL,NULL,NULL,NULL
150,250,NULL,NULL,NULL,NULL,NULL
200,300,10,10,10,10.0,10.0
300,400,9,4,1,2.25,2.0
350,450,9,4,1,2.25,2.0
450,550,NULL,NULL,NULL,NULL,NULL
500,600,NULL,NULL,NULL,NULL,NULL


# Keyed aggregation with only null values in the key
SELECT start, end, id,
       SUM(value) AS valueSum,
       MIN(value) AS valueMin,
       MAX(value) AS valueMax,
       AVG(value) AS valueAvg,
       COUNT(value) AS valueCount,
       COUNT(ts) AS rowCount
FROM stream2
WHERE ISNULL(id)
GROUP BY id
WINDOW TUMBLING(ts, size 1 sec)
INTO sink2;
----
0,1000,NULL,NULL,NULL,NULL,NULL,1,2
1000,2000,NULL,NULL,NULL,NULL,NULL,1,2

# Keyed aggregation with and w/o null values in the key
SELECT start, end, id,
       SUM(value) AS valueSum,
       MIN(value) AS valueMin,
       MAX(value) AS valueMax,
       AVG(value) AS valueAvg,
       COUNT(value) AS valueCount,
       COUNT(ts) AS rowCount
FROM stream2
GROUP BY id
WINDOW TUMBLING(ts, size 1 sec)
INTO sink2;
----
0,1000,NULL,NULL,NULL,NULL,NULL,1,2
0,1000,1,5,2,3,2.5,2,2
0,1000,3,NULL,NULL,NULL,NULL,0,2
1000,2000,NULL,NULL,NULL,NULL,NULL,1,2
1000,2000,1,NULL,NULL,NULL,NULL,1,2
1000,2000,3,NULL,NULL,NULL,NULL,0,1

SELECT start, end, MAX(value), MIN(value), AVG(value), MEDIAN(value)
FROM stream3
WINDOW TUMBLING(timestamp, size 1 sec)
INTO File();
----
2000,3000,NULL,NULL,NULL,NULL
3000,4000,NULL,NULL,NULL,NULL
