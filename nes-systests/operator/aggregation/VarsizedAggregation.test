# name: window/VarsizedAggregation.test
# description: Test window aggregations into a varsized
# groups: [Aggregation, WindowOperators]


Source stream UINT64 timestamp UINT8 character INLINE
0,72
1,101
2,108
3,108
4,111
5,87
6,111
7,114
8,108
9,100
10,72
11,101
12,108
13,108
14,111
15,87
16,111
17,114
18,108
19,100
20,72
21,101
22,108
23,108
24,111
25,87
26,111
27,114
28,108
29,100

SINK sinkStream UINT64 stream$start UINT64 stream$end VARSIZED stream$text


# Tests Merge Aggregation using characters
SELECT start, end, ARRAY_AGG(character) as text
FROM stream WINDOW TUMBLING(timestamp, size 10 ms) INTO sinkStream
----
0,10,HelloWorld
10,20,HelloWorld
20,30,HelloWorld


Source stream8ByteStream UINT64 timestamp UINT64 character INLINE
0,8245905578810697032
1,8307297884220712044
2,8388331938618102849
3,8382157055477956968
4,3761405301554571634

SINK sinkStream8Byte UINT64 stream8ByteStream$start UINT64 stream8ByteStream$end VARSIZED stream8ByteStream$text

# Tests Merge Aggregation using 8 byte integers. Note this test only works on small endian machines
SELECT start, end, ARRAY_AGG(character) as text
FROM stream8ByteStream WINDOW TUMBLING(timestamp, size 5 ms) INTO sinkStream8Byte
----
0,5,HelloWorldThisIsATestWithALongString1234

Source streamLong UINT64 timestamp UINT8 character INLINE
1000000000,72
1000000001,101
1000000002,108
1000000003,108
1000000004,111
1000000005,87
1000000006,111
1000000007,114
1000000008,108
1000000009,100
1000000010,72
1000000011,101
1000000012,108
1000000013,108
1000000014,111
1000000015,87
1000000016,111
1000000017,114
1000000018,108
1000000019,100
1000000020,72
1000000021,101
1000000022,108
1000000023,108
1000000024,111
1000000025,87
1000000026,111
1000000027,114
1000000028,108
1000000029,100
1000000030,72
1000000031,101
1000000032,108
1000000033,108
1000000034,111
1000000035,87
1000000036,111
1000000037,114
1000000038,108
1000000039,100
1000000040,72
1000000041,101
1000000042,108
1000000043,108
1000000044,111
1000000045,87
1000000046,111
1000000047,114
1000000048,108
1000000049,100
1000000050,72
1000000051,101
1000000052,108
1000000053,108
1000000054,111
1000000055,87
1000000056,111
1000000057,114
1000000058,108
1000000059,100
1000000060,72
1000000061,101
1000000062,108
1000000063,108
1000000064,111
1000000065,87
1000000066,111
1000000067,114
1000000068,108
1000000069,100
1000000070,72
1000000071,101
1000000072,108
1000000073,108
1000000074,111
1000000075,87
1000000076,111
1000000077,114
1000000078,108
1000000079,100
1000000080,72
1000000081,101
1000000082,108
1000000083,108
1000000084,111
1000000085,87
1000000086,111
1000000087,114
1000000088,108
1000000089,100
1000000090,72
1000000091,101
1000000092,108
1000000093,108
1000000094,111
1000000095,87
1000000096,111
1000000097,114
1000000098,108
1000000099,100
1000000000,72
1000000101,101
1000000102,108
1000000103,108
1000000104,111
1000000105,87
1000000106,111
1000000107,114
1000000108,108
1000000109,100
1000000110,72
1000000111,101
1000000112,108
1000000113,108
1000000114,111
1000000115,87
1000000116,111
1000000117,114
1000000118,108
1000000119,100
1000000120,72
1000000121,101
1000000122,108
1000000123,108
1000000124,111
1000000125,87
1000000126,111
1000000127,114
1000000128,108
1000000129,100
1000000130,72
1000000131,101
1000000132,108
1000000133,108
1000000134,111
1000000135,87
1000000136,111
1000000137,114
1000000138,108
1000000139,100
1000000140,72
1000000141,101
1000000142,108
1000000143,108
1000000144,111
1000000145,87
1000000146,111
1000000147,114
1000000148,108
1000000149,100
1000000150,72
1000000151,101
1000000152,108
1000000153,108
1000000154,111
1000000155,87
1000000156,111
1000000157,114
1000000158,108
1000000159,100
1000000160,72
1000000161,101
1000000162,108
1000000163,108
1000000164,111
1000000165,87
1000000166,111
1000000167,114
1000000168,108
1000000169,100
1000000170,72
1000000171,101
1000000172,108
1000000173,108
1000000174,111
1000000175,87
1000000176,111
1000000177,114
1000000178,108
1000000179,100
1000000180,72
1000000181,101
1000000182,108
1000000183,108
1000000184,111
1000000185,87
1000000186,111
1000000187,114
1000000188,108
1000000189,100
1000000190,72
1000000191,101
1000000192,108
1000000193,108
1000000194,111
1000000195,87
1000000196,111
1000000197,114
1000000198,108
1000000199,100
1000000200,72
1000000201,101
1000000202,108
1000000203,108
1000000204,111
1000000205,87
1000000206,111
1000000207,114
1000000208,108
1000000209,100
1000000210,72
1000000211,101
1000000212,108
1000000213,108
1000000214,111
1000000215,87
1000000216,111
1000000217,114
1000000218,108
1000000219,100
1000000220,72
1000000221,101
1000000222,108
1000000223,108
1000000224,111
1000000225,87
1000000226,111
1000000227,114
1000000228,108
1000000229,100
1000000230,72
1000000231,101
1000000232,108
1000000233,108
1000000234,111
1000000235,87
1000000236,111
1000000237,114
1000000238,108
1000000239,100
1000000240,72
1000000241,101
1000000242,108
1000000243,108
1000000244,111
1000000245,87
1000000246,111
1000000247,114
1000000248,108
1000000249,100
1000000250,72
1000000251,101
1000000252,108
1000000253,108
1000000254,111
1000000255,87
1000000256,111
1000000257,114
1000000258,108
1000000259,100
1000000260,72
1000000261,101
1000000262,108
1000000263,108
1000000264,111
1000000265,87
1000000266,111
1000000267,114
1000000268,108
1000000269,100
1000000270,72
1000000271,101
1000000272,108
1000000273,108
1000000274,111
1000000275,87
1000000276,111
1000000277,114
1000000278,108
1000000279,100
1000000280,72
1000000281,101
1000000282,108
1000000283,108
1000000284,111
1000000285,87
1000000286,111
1000000287,114
1000000288,108
1000000289,100
1000000290,72
1000000291,101
1000000292,108
1000000293,108
1000000294,111
1000000295,87
1000000296,111
1000000297,114
1000000298,108
1000000299,100
1000000300,72
1000000301,101
1000000302,108
1000000303,108
1000000304,111
1000000305,87
1000000306,111
1000000307,114
1000000308,108
1000000309,100
1000000310,72
1000000311,101
1000000312,108
1000000313,108
1000000314,111
1000000315,87
1000000316,111
1000000317,114
1000000318,108
1000000319,100
1000000320,72
1000000321,101
1000000322,108
1000000323,108
1000000324,111
1000000325,87
1000000326,111
1000000327,114
1000000328,108
1000000329,100
1000000330,72
1000000331,101
1000000332,108
1000000333,108
1000000334,111
1000000335,87
1000000336,111
1000000337,114
1000000338,108
1000000339,100
1000000340,72
1000000341,101
1000000342,108
1000000343,108
1000000344,111
1000000345,87
1000000346,111
1000000347,114
1000000348,108
1000000349,100
1000000350,72
1000000351,101
1000000352,108
1000000353,108
1000000354,111
1000000355,87
1000000356,111
1000000357,114
1000000358,108
1000000359,100
1000000360,72
1000000361,101
1000000362,108
1000000363,108
1000000364,111
1000000365,87
1000000366,111
1000000367,114
1000000368,108
1000000369,100
1000000370,72
1000000371,101
1000000372,108
1000000373,108
1000000374,111
1000000375,87
1000000376,111
1000000377,114
1000000378,108
1000000379,100
1000000380,72
1000000381,101
1000000382,108
1000000383,108
1000000384,111
1000000385,87
1000000386,111
1000000387,114
1000000388,108
1000000389,100
1000000390,72
1000000391,101
1000000392,108
1000000393,108
1000000394,111
1000000395,87
1000000396,111
1000000397,114
1000000398,108
1000000399,100
1000000400,72
1000000401,101
1000000402,108
1000000403,108
1000000404,111
1000000405,87
1000000406,111
1000000407,114
1000000408,108
1000000409,100
1000000410,72
1000000411,101
1000000412,108
1000000413,108
1000000414,111
1000000415,87
1000000416,111
1000000417,114
1000000418,108
1000000419,100
1000000420,72
1000000421,101
1000000422,108
1000000423,108
1000000424,111
1000000425,87
1000000426,111
1000000427,114
1000000428,108
1000000429,100
1000000430,72
1000000431,101
1000000432,108
1000000433,108
1000000434,111
1000000435,87
1000000436,111
1000000437,114
1000000438,108
1000000439,100
1000000440,72
1000000441,101
1000000442,108
1000000443,108
1000000444,111
1000000445,87
1000000446,111
1000000447,114
1000000448,108
1000000449,100
1000000450,72
1000000451,101
1000000452,108
1000000453,108
1000000454,111
1000000455,87
1000000456,111
1000000457,114
1000000458,108
1000000459,100
1000000460,72
1000000461,101
1000000462,108
1000000463,108
1000000464,111
1000000465,87
1000000466,111
1000000467,114
1000000468,108
1000000469,100
1000000470,72
1000000471,101
1000000472,108
1000000473,108
1000000474,111
1000000475,87
1000000476,111
1000000477,114
1000000478,108
1000000479,100
1000000480,72
1000000481,101
1000000482,108
1000000483,108
1000000484,111
1000000485,87
1000000486,111
1000000487,114
1000000488,108
1000000489,100
1000000490,72
1000000491,101
1000000492,108
1000000493,108
1000000494,111
1000000495,87
1000000496,111
1000000497,114
1000000498,108
1000000499,100
1000000500,72
1000000501,101
1000000502,108
1000000503,108
1000000504,111
1000000505,87
1000000506,111
1000000507,114
1000000508,108
1000000509,100
1000000510,72
1000000511,101
1000000512,108
1000000513,108
1000000514,111
1000000515,87
1000000516,111
1000000517,114
1000000518,108
1000000519,100
1000000520,72
1000000521,101
1000000522,108
1000000523,108
1000000524,111
1000000525,87
1000000526,111
1000000527,114
1000000528,108
1000000529,100
1000000530,72
1000000531,101
1000000532,108
1000000533,108
1000000534,111
1000000535,87
1000000536,111
1000000537,114
1000000538,108
1000000539,100
1000000540,72
1000000541,101
1000000542,108
1000000543,108
1000000544,111
1000000545,87
1000000546,111
1000000547,114
1000000548,108
1000000549,100
1000000550,72
1000000551,101
1000000552,108
1000000553,108
1000000554,111
1000000555,87
1000000556,111
1000000557,114
1000000558,108
1000000559,100
1000000560,72
1000000561,101
1000000562,108
1000000563,108
1000000564,111
1000000565,87
1000000566,111
1000000567,114
1000000568,108
1000000569,100
1000000570,72
1000000571,101
1000000572,108
1000000573,108
1000000574,111
1000000575,87
1000000576,111
1000000577,114
1000000578,108
1000000579,100
1000000580,72
1000000581,101
1000000582,108
1000000583,108
1000000584,111
1000000585,87
1000000586,111
1000000587,114
1000000588,108
1000000589,100
1000000590,72
1000000591,101
1000000592,108
1000000593,108
1000000594,111
1000000595,87
1000000596,111
1000000597,114
1000000598,108
1000000599,100
1000000600,72
1000000601,101
1000000602,108
1000000603,108
1000000604,111
1000000605,87
1000000606,111
1000000607,114
1000000608,108
1000000609,100
1000000610,72
1000000611,101
1000000612,108
1000000613,108
1000000614,111
1000000615,87
1000000616,111
1000000617,114
1000000618,108
1000000619,100
1000000620,72
1000000621,101
1000000622,108
1000000623,108
1000000624,111
1000000625,87
1000000626,111
1000000627,114
1000000628,108
1000000629,100
1000000630,72
1000000631,101
1000000632,108
1000000633,108
1000000634,111
1000000635,87
1000000636,111
1000000637,114
1000000638,108
1000000639,100
1000000640,72
1000000641,101
1000000642,108
1000000643,108
1000000644,111
1000000645,87
1000000646,111
1000000647,114
1000000648,108
1000000649,100
1000000650,72
1000000651,101
1000000652,108
1000000653,108
1000000654,111
1000000655,87
1000000656,111
1000000657,114
1000000658,108
1000000659,100
1000000660,72
1000000661,101
1000000662,108
1000000663,108
1000000664,111
1000000665,87
1000000666,111
1000000667,114
1000000668,108
1000000669,100
1000000670,72
1000000671,101
1000000672,108
1000000673,108
1000000674,111
1000000675,87
1000000676,111
1000000677,114
1000000678,108
1000000679,100
1000000680,72
1000000681,101
1000000682,108
1000000683,108
1000000684,111
1000000685,87
1000000686,111
1000000687,114
1000000688,108
1000000689,100
1000000690,72
1000000691,101
1000000692,108
1000000693,108
1000000694,111
1000000695,87
1000000696,111
1000000697,114
1000000698,108
1000000699,100
1000000700,72
1000000701,101
1000000702,108
1000000703,108
1000000704,111
1000000705,87
1000000706,111
1000000707,114
1000000708,108
1000000709,100
1000000710,72
1000000711,101
1000000712,108
1000000713,108
1000000714,111
1000000715,87
1000000716,111
1000000717,114
1000000718,108
1000000719,100
1000000720,72
1000000721,101
1000000722,108
1000000723,108
1000000724,111
1000000725,87
1000000726,111
1000000727,114
1000000728,108
1000000729,100
1000000730,72
1000000731,101
1000000732,108
1000000733,108
1000000734,111
1000000735,87
1000000736,111
1000000737,114
1000000738,108
1000000739,100
1000000740,72
1000000741,101
1000000742,108
1000000743,108
1000000744,111
1000000745,87
1000000746,111
1000000747,114
1000000748,108
1000000749,100

SINK sinkStream2 UINT64 streamLong$start UINT64 streamLong$end VARSIZED streamLong$text

# Test in order behavior of the ARRAY_AGG. This currently requires a work around which prevents the CSV formatter
# from introducing chunked sequence numbers, which is why the timestamp is so large to prevent a scenario where the raw
# input buffer is smaller than the resulting output buffer. If you were to disable the `requiresSequentialAggregation`
# property you would observe that the output string does not match the expected. (Might require a few tries).

SELECT start, end, ARRAY_AGG(character) as text
FROM streamLong WINDOW TUMBLING(timestamp, size 1000 ms) INTO sinkStream2
----
1000000000,1000001000,HelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorldHelloWorld
