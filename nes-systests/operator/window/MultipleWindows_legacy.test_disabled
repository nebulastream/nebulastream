# name: window/MultipleWindow_legacy.test
# description: Test window operator from legacy test MultipleWindowTest
# groups: [Legacy]

# Source definitions
Source stream UINT64 id UINT64 value UINT64 timestamp
1,1,1000
12,1,1001
4,1,1002
1,2,2000
11,2,2001
16,2,2002
1,3,3000
11,3,3001
1,3,3003
1,3,3200
1,4,4000
1,5,5000
1,6,6000
1,7,7000
1,8,8000
1,9,9000
1,10,10000
1,11,11000
1,12,12000
1,13,13000
1,14,14000
1,15,15000
1,16,16000
1,17,17000
1,18,18000
1,19,19000
1,20,20000
1,21,21000


Query::from("window")
    .filter(Attribute("id") < 15)
    .window(TumblingWindow::of(EventTime(Attribute("timestamp")), Seconds(1))).byKey(Attribute("id"))
    .apply(Sum(Attribute("value")))
    .filter(Attribute("id") < 10)
    .window(TumblingWindow::of(EventTime(Attribute("start")), Seconds(2))).byKey(Attribute("id"))
    .apply(Sum(Attribute("value")))
    .SINK;
----
0 2000 1 1
0 2000 4 1
10000 12000 1 21
12000 14000 1 25
14000 16000 1 29
16000 18000 1 33
18000 20000 1 37
2000 4000 1 11
20000 22000 1 41
4000 6000 1 9
6000 8000 1 13
8000 10000 1 17

Query::from("window")
    .filter(Attribute("id") < 15)
    .window(TumblingWindow::of(EventTime(Attribute("timestamp")), Seconds(1))).byKey(Attribute("id"))
    .apply(Sum(Attribute("value")))
    .filter(Attribute("id") < 10)
    .window(TumblingWindow::of(EventTime(Attribute("start")), Seconds(2))).byKey(Attribute("id"))
    .apply(Sum(Attribute("value")))
    .SINK;
----
0 2000 1 1
0 2000 4 1
10000 12000 1 21
12000 14000 1 25
14000 16000 1 29
16000 18000 1 33
18000 20000 1 37
2000 4000 1 11
20000 22000 1 41
4000 6000 1 9
6000 8000 1 13
8000 10000 1 17

Query::from("window")
    .window(SlidingWindow::of(EventTime(Attribute("timestamp")), Seconds(5), Seconds(5)))
    .byKey(Attribute("id")).apply(Sum(Attribute("value")))
    .assignWatermark(EventTimeWatermarkStrategyDescriptor::create(Attribute("start"), Milliseconds(0), Milliseconds()))
    .window(SlidingWindow::of(EventTime(Attribute("start")), Seconds(10), Seconds(5)))
    .byKey(Attribute("id")).apply(Sum(Attribute("value")))
    .SINK;
----
0 10000 1 51
0 10000 4 1
0 10000 11 5
0 10000 12 1
0 10000 16 2
5000 15000 1 95
10000 20000 1 145
15000 25000 1 126
20000 30000 1 41

Query::from("window")
    .filter(Attribute("id") < 15)
    .window(TumblingWindow::of(EventTime(Attribute("timestamp")), Seconds(2)))
    .byKey(Attribute("id"))
    .apply(Sum(Attribute("value")))
    .filter(Attribute("id") < 10)
    .assignWatermark(EventTimeWatermarkStrategyDescriptor::create(Attribute("start"), Milliseconds(0), Milliseconds()))
    .window(SlidingWindow::of(EventTime(Attribute("start")), Seconds(1), Milliseconds(500)))
    .byKey(Attribute("id")).apply(Sum(Attribute("value")))
    .SINK;
----
0 1000 1 1
0 1000 4 1
2000 3000 1 11
4000 5000 1 9
6000 7000 1 13
8000 9000 1 17
10000 11000 1 21
12000 13000 1 25
14000 15000 1 29
16000 17000 1 33
18000 19000 1 37
20000 21000 1 41

Query::from("window")
    .filter(Attribute("id") < 15)
    .window(SlidingWindow::of(EventTime(Attribute("timestamp")), Seconds(1), Milliseconds(500))).byKey(Attribute("id"))
    .apply(Sum(Attribute("value")))
    .assignWatermark(EventTimeWatermarkStrategyDescriptor::create(Attribute("start"), Milliseconds(0), Milliseconds()))
    .window(TumblingWindow::of(EventTime(Attribute("start")), Seconds(1))).byKey(Attribute("id"))
    .apply(Sum(Attribute("value")))
    .filter(Attribute("id") < 10)
    .assignWatermark(EventTimeWatermarkStrategyDescriptor::create(Attribute("start"), Milliseconds(0), Milliseconds()))
    .window(TumblingWindow::of(EventTime(Attribute("start")), Seconds(2)))
    .apply(Sum(Attribute("value")))
    .SINK;
----
0 2000 4
2000 4000 24
4000 6000 20
6000 8000 28
8000 10000 36
10000 12000 44
12000 14000 52
14000 16000 60
16000 18000 68
18000 20000 76
20000 22000 62
