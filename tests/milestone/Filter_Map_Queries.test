# name: milestone/Filter_Map_Queries.test
# description: Simple tests that contain map and filter
# groups: [Filter, Map]

# LLVM LIT configuration
# RUN: sed -e "s@SINK@%sink@g" -e "s@TESTDATA@%testdata@g"< %s > %t &&  rm %tsink || true
# RUN: %client test -f %t -s %worker_address && %result_checker %t %tsink

Source window INT64 id INT64 value UINT64 timestamp
1,1,1000
2,1,1001
3,11,1002
4,412,2000
5,312,2012
6,22,2021

# Filter and then map
Query::from("window")
    .filter(Attribute("value") != 1)
    .map(Attribute("id") = Attribute("id") * 3)
    .SINK;
----
9,11,1002
12,412,2000
15,312,2012
18,22,2021

# Filter, Map and then Filter again
Query::from("window")
    .filter(Attribute("value") != 1)
    .map(Attribute("id") = Attribute("id") * 3)
    .filter(Attribute("id") != 9)
    .filter(Attribute("value") != 312)
    .SINK;
----
12,412,2000
18,22,2021


# Map, filter and then map again
Query::from("window")
    .map(Attribute("id") = Attribute("id") * 3)
    .filter(Attribute("value") == 1)
    .map(Attribute("id") = Attribute("id") * 3)
    .SINK;
----
9,1,1000
18,1,1001

# Nested Map functions and the second map depends on the first map
Query::from("window")
    .map(Attribute("id") = (Attribute("id") * 3 / Attribute("value")) + (Attribute("value") * 2))
    .map(Attribute("value") = Attribute("value") * 25 - (Attribute("id") * 5) - 125)
    .SINK;
----
5,-125,1000
8,-140,1001
22,40,1002
824,6055,2000
624,4555,2012
44,205,2021

