# name: map/Map_Add.test
# description: Simple map tests with an add function
# groups: [Map]

# LLVM LIT configuration
# RUN: sed -e "s@SINK@%sink@g" -e "s@TESTDATA@%testdata@g"< %s > %t &&  rm %tsink || true
# RUN: %client test -f %t -s %worker_address && %result_checker %t %tsink

Source window UINT64 id UINT64 value UINT64 timestamp
1,1,1000
2,1,1001
3,1,1002
4,2,2000
5,19,19000
6,20,20000
7,21,21000

# Map with add function touches one field
Query::from("window")
    .map(Attribute("id") = Attribute("id") + 1)
    .SINK;
----
2,1,1000
3,1,1001
4,1,1002
5,2,2000
6,19,19000
7,20,20000
8,21,21000

# Map with add function touches two fields
Query::from("window")
    .map(Attribute("id") = Attribute("id") + Attribute("value"))
    .SINK;
----
2,1,1000
3,1,1001
4,1,1002
6,2,2000
24,19,19000
26,20,20000
28,21,21000

# Map with add function touches two fields and adds a new field
Query::from("window")
    .map(Attribute("new") = Attribute("id") + Attribute("value"))
    .SINK;
----
1,1,1000,2
2,1,1001,3
3,1,1002,4
4,2,2000,6
5,19,19000,24
6,20,20000,26
7,21,21000,28


# Two maps after each other that both touch the same fields
Query::from("window")
    .map(Attribute("id") = Attribute("id") + 1)
    .map(Attribute("id") = Attribute("value") + Attribute("id"))
    .SINK;
----
3,1,1000
4,1,1001
5,1,1002
7,2,2000
25,19,19000
27,20,20000
29,21,21000

# Three maps after each other that use a newly created field to create another field
Query::from("window")
    .map(Attribute("id") = Attribute("id") + 1)
    .map(Attribute("new") = Attribute("id") + Attribute("value"))
    .map(Attribute("new2") = Attribute("new") + Attribute("value"))
    .SINK;
----
2,1,1000,3,4
3,1,1001,4,5
4,1,1002,5,6
5,2,2000,7,9
6,19,19000,25,44
7,20,20000,27,47
8,21,21000,29,50

# Four maps that use a newly created field to create another field,
# but we keep id, and new2 only. We also add id and new2 together in the end.
Query::from("window")
    .map(Attribute("id") = Attribute("id") + 1)
    .map(Attribute("new") = Attribute("id") + Attribute("value"))
    .map(Attribute("new2") = Attribute("new") + Attribute("value"))
    .project(Attribute("id"), Attribute("new2"))
    .map(Attribute("id") = Attribute("id") + Attribute("new2"))
    .SINK;
----
6,4
8,5
10,6
14,9
50,44
54,47
58,50
