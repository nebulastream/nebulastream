# name: projection/ProjectionWithFilterAndMap.test
# description: Simple map tests with an add function
# groups: [Projection, Filter, Map]

Source window UINT64 id UINT64 value UINT64 timestamp
1,1,1000
2,1,1001
3,1,1002
4,2,2000
5,19,19000
6,20,20000
7,21,21000

# 0: first filter on 'timestamp', then project on 'id'
Query::from("window")
    .filter(Attribute("timestamp") == 1002)
    .project(Attribute("id"))
    .SINK
----
3

# 1: first filter on 'timestamp' and 'value', then project on 'id'
Query::from("window")
    .filter(Attribute("timestamp") == 1002 && Attribute("value") == 1)
    .project(Attribute("id"))
    .SINK
----
3

# 2: filter -> project [id]
Query::from("window")
    .filter(Attribute("id") == 1)
    .project(Attribute("id"))
    .SINK
----
1

# 3: project -> filter  [id]
Query::from("window")
    .project(Attribute("id"))
    .filter(Attribute("id") == 1)
    .SINK
----
1

# 4: project -> filter -> map [id]
Query::from("window")
    .project(Attribute("id"))
    .filter(Attribute("id") == 1)
    .map(Attribute("id") = Attribute("id") * 2)
    .SINK
----
2

# 5: project -> map -> filter [id] (all iterations with project first done)
Query::from("window")
    .project(Attribute("id"))
    .map(Attribute("id") = Attribute("id") * 2)
    .filter(Attribute("id") == 1)
    .SINK
----

# 6: filter -> map -> project [id]
Query::from("window")
    .filter(Attribute("id") == 1)
    .map(Attribute("id") = Attribute("id") * 2)
    .project(Attribute("id"))
    .SINK
----
2

# 7: filter -> project -> map [id] (all iterations with filter first done)
Query::from("window")
    .filter(Attribute("id") == 1)
    .project(Attribute("id"))
    .map(Attribute("id") = Attribute("id") * 2)
    .SINK
----
2

# 8: map -> filter -> project [id]
Query::from("window")
    .map(Attribute("id") = Attribute("id") * 2)
    .filter(Attribute("id") == 1)
    .project(Attribute("id"))
    .SINK
----

# 9: map -> project -> filter [id] (all iterations with map first done)
Query::from("window")
    .map(Attribute("id") = Attribute("id") * 2)
    .project(Attribute("id"))
    .filter(Attribute("id") == 1)
    .SINK
----

# 10: filter -> map -> project [id -> new_id]
Query::from("window")
    .filter(Attribute("id") == 1)
    .map(Attribute("new_id") = Attribute("id") * 2)
    .project(Attribute("new_id"))
    .SINK
----
2

# 11: map -> project -> filter [id * 2 -> new_id]
Query::from("window")
    .map(Attribute("new_id") = Attribute("id") * 2)
    .project(Attribute("new_id"))
    .filter(Attribute("new_id") == 1)
    .SINK
----

# 12: map -> filter -> project [id * 2 -> new_id]
Query::from("window")
    .map(Attribute("new_id") = Attribute("id") * 2)
    .filter(Attribute("new_id") == 1)
    .project(Attribute("new_id"))
    .SINK
----

# 13: filter -> map ->  project [id, id * 2 -> new_id, value, timestamp]
Query::from("window")
    .filter(Attribute("id") == 1)
    .map(Attribute("new_id") = Attribute("id") * 2)
    .project(Attribute("id"), Attribute("new_id"), Attribute("value"), Attribute("timestamp"))
    .SINK
----
1 2 1 1000

# 14: filter -> map -> project -> map -> map [new_id -> id, value, timestamp]
Query::from("window")
    .filter(Attribute("id") == 1)
    .map(Attribute("new_id") = Attribute("id") * 2)
    .project(Attribute("new_id"))
    .map(Attribute("id") = Attribute("new_id") / 2)
    .map(Attribute("value") = Attribute("id"))
    .map(Attribute("timestamp") = Attribute("id") * 1000)
    .SINK
----
2 1 1 1000
