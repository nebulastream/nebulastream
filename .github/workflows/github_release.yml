name: NES Release

# The following pipeline, is executed whenever we create a new version tag at the main repository.
# The pipeline first creates a new tag at nebulastream/nebulastream-dev-builds and nebulastream/nebulastream-demo, which
# have the same tag_name as the $GITHUB_REF_NAME. Thus, if the master version tag is v10 also the tag_name is v10.
# In the final step, the pipeline builds the individual debian packages and adds them to a release under the new tag.
# This pipeline is not triggered automatically and must be triggered manually whenever a new version is ready to be released.

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Perform Major or Minor Release'
        type: choice
        required: true
        options:
          - Major
          - Minor

jobs:
  release:
    runs-on: [ self-hosted, linux, X64, Build ]
    if: github.ref == 'refs/heads/master'
    env:
      DOCKER_USER_NAME: ${{ secrets.DOCKER_USER_NAME}}
      DOCKER_SECRET: ${{ secrets.DOCKER_SECRET}}
      EVENT: ${{ github.event_name }}
      NEXT_VERSION: ${{ github.event.inputs.version }}
    steps:
      - uses: AutoModality/action-clean@v1
      - uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.CI_SECRET }}
          fetch-depth: 0
      - name: Get changed files using defaults
        id: changed-files
        uses: tj-actions/changed-files@v41.0.0
      - name: Get changed files using a comma separator
        id: changed-files-comma-separate
        uses: tj-actions/changed-files@v41.0.0
        with:
          separator: ","
      - name: "Set up QEMU"
        uses: docker/setup-qemu-action@v3
      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3
      - name: "Get NebulaStream Version"
        run: |
          NES_VERSION=$(grep -o "NES_VERSION.*" nes-common/include/Version/version.hpp | grep -o "\".*\"" |  sed -e 's/^.//' -e 's/-.*$//')
          if [[ "${{ github.event_name }}"  =~ "workflow_dispatch" ]]; then
            if [[ "${{ env.NEXT_VERSION }}" =~ "Minor" ]]; then
              NES_VERSION=$(echo $NES_VERSION | awk -F. -v OFS=. '{$2 +=1 ; $3 = 0 ; print}')
            else
              NES_VERSION=$(echo $NES_VERSION | awk -F. -v OFS=. '{$1 +=1 ; $2 =0 ; $3 = 0 ; print}')
            fi
          fi
          echo "NES_VERSION=$NES_VERSION" >> $GITHUB_ENV
      - name: "Build and Release NES Build Image"
        if: github.event_name != 'workflow_dispatch' && contains(steps.changed-files.outputs.modified_files, 'docker/buildImage/')
        run: |
          echo "Found changes done to buildImage"
          cd docker/buildImage
          #When we decide on weather to use the version as tag or not we can use the below command to extract the current version.
          #grep -o "\".*\"" include/Version/version.hpp | sed -e 's/^.//' -e 's/.$//'
          echo "$DOCKER_SECRET" | docker login -u "$DOCKER_USER_NAME" --password-stdin
          docker buildx build . -f Dockerfile-NES-Build -t nebulastream/nes-build-image:latest --platform=linux/amd64,linux/arm64 --push
          echo "Pushed the build image"        
          docker logout
      - name: "Build and Release NES Dev Image"
        if: github.event_name != 'workflow_dispatch' && (contains(steps.changed-files.outputs.modified_files, 'docker/buildImage/') || contains(steps.changed-files.outputs.modified_files, 'docker/devImage/'))
        run: |
          echo "Found changes done to devImage"
          cd docker/devImage/
          echo "$DOCKER_SECRET" | docker login -u "$DOCKER_USER_NAME" --password-stdin
          docker buildx build . -f Dockerfile-NES-Dev -t nebulastream/nes-dev-image:latest --platform=linux/amd64,linux/arm64 --push
          echo "Pushed the dev image"          
          docker logout
      - name: "Generate ChangeLogs"
        uses: heinrichreimer/github-changelog-generator-action@v2.4
        with:
          token: ${{ secrets.NES_CI_SECRET }}
          issues: true
          #maxIssues: 500
          issuesWoLabels: true
          pullRequests: false
          prWoLabels: true
          author: true
          compareLink: true
          stripGeneratorNotice: true
          futureRelease: v${{ env.NES_VERSION }}
          bugsLabel: "### Bug Fixes ðŸ›"
          issuesLabel: "### Miscellaneous Issues âœŒï¸"
          addSections: '{"optimizer":{"prefix":"### Query Optimizer ðŸ”§","labels":["Query Optimizer", "QueryMerge"]},
          "Spatial": {"prefix": "#### Spatial Query Processing ðŸŒ‡", "labels":["Spatial Query Processing"]}, 
          "monitoring": {"prefix": "#### Monitoring ðŸš¥", "labels":["Monitoring"]},
          "cep": {"prefix": "#### Complex Event Processing", "labels":["Complex Event Processing"]},
          "runtime": {"prefix": "#### Runtime ", "labels":["Runtime"]},
          "udf": {"prefix": "#### User Defined Functions", "labels":["User Defined Functions"]},
          "query compiler": {"prefix": "#### Query Compiler", "labels":["Query Compiler"]},
          "fault tolerance": {"prefix": "#### Fault Tolerance", "labels":["Fault Tolerance"]},
          "build management": {"prefix": "#### Build Management", "labels":["Build Management"]},
          "operators": {"prefix": "#### Operators ", "labels":["Operators"]},
          "state management": {"prefix": "#### State Management ", "labels":["State Management"]},
          "rest": {"prefix": "#### REST API ", "labels":["REST"]},
          "documentation": {"prefix": "#### Documentation ", "labels":["Documentation"]}
          }'
      - name: "Commit Updated Changelog File"
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "GIT-CI: Adding changelog for version v${{ env.NES_VERSION }}"
          file_pattern: CHANGELOG.md
      - name: "Release Tag"
        env:
          CI_SECRET: ${{ secrets.CI_SECRET }}
        run: |
          echo "$CI_SECRET" | base64 -w 0 > $GITHUB_WORKSPACE/ci_secret.txt     
          if [[ $EVENT == 'workflow_dispatch' ]]; then
            docker run -v $GITHUB_WORKSPACE/ci_secret.txt:/ci_secret.txt -v $GITHUB_WORKSPACE:/nebulastream --privileged --cap-add SYS_NICE  -e RELEASE_TYPE=$NEXT_VERSION --entrypoint /nebulastream/docker/buildImage/entrypoint-nes-release.sh nebulastream/nes-build-image:latest
          else
            docker run -v $GITHUB_WORKSPACE/ci_secret.txt:/ci_secret.txt -v $GITHUB_WORKSPACE:/nebulastream --privileged --cap-add SYS_NICE --entrypoint /nebulastream/docker/buildImage/entrypoint-nes-release.sh nebulastream/nes-build-image:latest
          fi
      - name: "Push Docs To Pages"
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.CI_TOKEN }}
          publish_dir: ./build/cmake/docs/html
          external_repository: nebulastream/nebulastream-docs
          publish_branch: master

  create-tag:
    runs-on: [self-hosted, linux, X64, Build]
    steps:
     - uses: actions/checkout@v4
       with:
        ssh-strict: 'false'
        fetch-depth: '0'
        ssh-key: ${{ secrets.CI_SECRET }}
        token: ${{ secrets.CI_TOKEN }}
        repository: 'nebulastream/nebulastream-dev-builds'
        path: nebulastream
     - name: "Create Tag in nebulastream-dev-builds Repo"
       run: |
         cd nebulastream
         tag_name=$GITHUB_REF_NAME
         git config --global user.email "${{ secrets.CI_EMAIL }}"
         git config --global user.name "CIUser"         
         git tag -fa "$tag_name" -m "$tag_name"
         git push --force origin "$tag_name"

  create-tag-tutorial:
    runs-on: [self-hosted, linux, X64, Build]
    steps:
      - uses: actions/checkout@v4
        with:
          ssh-strict: 'false'
          fetch-depth: '0'
          ssh-key: ${{ secrets.CI_SECRET }}
          token: ${{ secrets.CI_TOKEN }}
          repository: 'nebulastream/nebulastream-tutorial'
          path: nebulastream-tutorial
      - name: "Create Tag in nebulastream-tutorial Repo"
        run: |
          cd nebulastream-tutorial
          tag_name=$GITHUB_REF_NAME
          git config --global user.email "${{ secrets.CI_EMAIL }}"
          git config --global user.name "CIUser"         
          git tag -fa "$tag_name" -m "$tag_name"
          git push --force origin "$tag_name"

  package-debian-package:
    needs: [create-tag, create-tag-tutorial]
    env:
      DOCKER_USER_NAME: ${{ secrets.DOCKER_USER_NAME}}
      DOCKER_SECRET: ${{ secrets.DOCKER_SECRET}}
    runs-on: [ self-hosted, linux, '${{ matrix.arch }}', Build ]
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        arch: [X64, arm64]
        osversion: [ubuntu-20_04, ubuntu-22_04]
    steps:
      - uses: AutoModality/action-clean@v1
      - name: "Checkout NebulaStream Repository"
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.CI_SECRET }}
          ssh-strict: 'false'
          fetch-depth: '0'
          token: ${{ secrets.CI_TOKEN }}
      - name: "Fetch Changelog Entry For The Tag"
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v1
        with:
          version: $GITHUB_REF_NAME
          path: CHANGELOG.md
      - name: Build Docker
        working-directory: ${{ github.workspace }}/docker/buildImage
        run: docker build  -t nes_package_${{ matrix.osversion }} -f Dockerfile-NES-Build-${{ matrix.osversion }} .
      - name: "Build Debian Packages"
        run: |
          cache_dir="/data/nes-ci/tmp/nes-ccache_${{ matrix.osversion }}_${{ matrix.arch }}"
          echo "cache_dir=$cache_dir"
          mkdir -p $cache_dir
          RUNNER=$(basename $(dirname $(dirname $(dirname $(pwd)))))
          build_dir="/data/nes-ci/tmp/nes-build_$RUNNER_${RUNNER_NAME}_${{ matrix.osversion }}_${{ matrix.arch }}"
          echo "build_dir=$build_dir"
          echo "build_dir=$build_dir" >> $GITHUB_ENV     
          mkdir -p $build_dir
          docker run --name ${{ github.run_id }}_${{ matrix.osversion }}_package -v $cache_dir:/cache_dir -v $build_dir:/build_dir -v $GITHUB_WORKSPACE:/nebulastream --privileged --cap-add SYS_NICE --entrypoint /nebulastream/docker/buildImage/entrypoint-prepare-nes-package.sh nes_package_${{ matrix.osversion }}
      - name: "Fetch Debian Files"
        run: |
          nes_version=${GITHUB_REF_NAME:1}
          DEB_NAME=NebulaStream-$nes_version-${{ matrix.osversion}}-Linux.${{ matrix.arch }}
          mv ${{ env.build_dir }}/*deb ${{ env.build_dir }}/$DEB_NAME.deb
          echo "DEB_FILE=${{ env.build_dir }}/$DEB_NAME.deb" >> $GITHUB_ENV
      - name: "Perform Release for nebulastream-dev-builds Repository"
        uses: softprops/action-gh-release@v0.1.14
        with:
          files: |
            ${{ env.DEB_FILE }}
          repository: nebulastream/nebulastream-dev-builds
          token: ${{ secrets.CI_TOKEN }}
          body: ${{ steps.changelog_reader.outputs.log_entry }}
      - name: "Perform Release for nebulastream Repository"
        uses: softprops/action-gh-release@v0.1.14
        with:
          files: |
            ${{ env.DEB_FILE }}
          repository: nebulastream/nebulastream
          token: ${{ secrets.CI_TOKEN }}
          body: ${{ steps.changelog_reader.outputs.log_entry }}
      - name: "Perform Docker Cleanup"
        if: ${{ always() }}
        run: |
          docker rm -f ${{ github.run_id }}_${{ matrix.osversion }}_package

  build-docker:
    needs: [package-debian-package]
    runs-on: [ self-hosted, linux, X64, Build ]
    env:
      DOCKER_USER_NAME: ${{ secrets.DOCKER_USER_NAME}}
      DOCKER_SECRET: ${{ secrets.DOCKER_SECRET}}
      UBUNTU_VERSION: 22_04
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: "Build and Release NES Executable Image"
        run: |
          nes_version=${GITHUB_REF_NAME:1}
          echo "Preparing and Releasing new executable image with version $nes_version and latest"
          echo "$DOCKER_SECRET" | docker login -u "$DOCKER_USER_NAME" --password-stdin
          wget --no-check-certificate -O nes-amd64.deb https://github.com/nebulastream/nebulastream-dev-builds/releases/download/$GITHUB_REF_NAME/NebulaStream-$nes_version-ubuntu-$UBUNTU_VERSION-Linux.X64.deb
          wget --no-check-certificate -O nes-arm64.deb https://github.com/nebulastream/nebulastream-dev-builds/releases/download/$GITHUB_REF_NAME/NebulaStream-$nes_version-ubuntu-$UBUNTU_VERSION-Linux.arm64.deb
          docker buildx build . -f docker/executableImage/Dockerfile-NES-Executable-Multi-Arch --platform=linux/amd64,linux/arm64 --tag nebulastream/nes-executable-image:$nes_version --tag nebulastream/nes-executable-image:latest --push
          rm -rf nes-amd64.deb nes-arm64.deb
          echo "Pushed the execution image"
          docker logout

  Java-Client-CI-Dispatch:
    needs: [build-docker]
    runs-on: [ self-hosted, linux, X64, Build ]
    env:
      VERSION: ${{ github.ref_name }}
    steps:
      - name: "Repository dispatch for Java-Client"
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.CI_TOKEN }}
          repository: nebulastream/nebulastream-java-client
          event-type: nes-executable-image-update
          client-payload: '{"version": "${{ env.VERSION }}"}'

  Run-Regression-Tests:
    needs: [build-docker]
    runs-on: [ self-hosted, linux, X64, Build ]
    env:
      DOCKER_USER_NAME: ${{ secrets.DOCKER_USER_NAME}}
      DOCKER_SECRET: ${{ secrets.DOCKER_SECRET}}
    steps:
      - name: KTM Use Case Regression Test
        run: |
          cp ./docker/regressionImage/run.sh ./docker/regressionImage/KTM/
          sh ./docker/regressionImage/KTM/run.sh
      - name: Video Use Case Regression Test
        run: |
          cp ./docker/regressionImage/run.sh ./docker/regressionImage/Video/
          sh ./docker/regressionImage/Video/run.sh
      - name: Smart Meter Use Case Regression Test
        run: |
          cp ./docker/regressionImage/run.sh ./docker/regressionImage/SmartMeter/
          sh ./docker/regressionImage/SmartMeter/run.sh
      - name: Medic Regression Test
        run: |
          cp ./docker/regressionImage/run.sh ./docker/regressionImage/Med/
          sh ./docker/regressionImage/Med/run.sh