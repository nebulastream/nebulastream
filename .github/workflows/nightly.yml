name: NES Nightly

# This workflow is triggered every night at 2:30 AM UTC.
# This is a good way to ensure that the main branch is always in a good state.
# For now, this workflow file runs the same tests as `pr.yml` and then creates a docker image nes-executable-image:nightly, if the test pass.
# For pushing an image to the docker hub, we build debian packages (nes-amd64.deb and nes-arm64.deb) and then use them to build the docker image.
# We will add long-running test for stability and performance checks in the future.

on:
  workflow_dispatch:
    inputs:
      iters:
        required: true
        type: number
      skip:
        required: true
        type: number
  schedule:
    - cron: '30 2 * * *' # gets executed every night at 4:30 AM CEST

jobs:
  get-dev-images:
    uses: ./.github/workflows/get_dev_images.yml
    secrets: inherit
    with:
      ref: ${{ github.sha }}
      branch-name: ${{ github.ref_name }}
  
  check-for-broken-inputs:
    name: "run mutational analysis"
    needs: [ get-dev-images ]
    container:
      image: nebulastream/nes-development:${{ needs.get-dev-images.outputs.image-tag }}-libstdcxx-none
      volumes:
        - ccache:/ccache
        - test-file-cache:/test-file-cache
      env:
        CCACHE_DIR: /ccache
        MOLD_JOBS: 1
      # TODO #401 Investigate rootless docker containers
      options: --user root --ulimit core=0
    runs-on: [ self-hosted, linux, Build, x64 ]
    steps:
      - uses: actions/checkout@v4
      - name: mkdirs
        run: |
          mkdir /out
          mkdir /wdir
      - name: run mutanalysis
        run: |
          export FWC_NES_CORPORA_TOKEN=${{ secrets.FWC_NES_CORPORA }}
          bash scripts/fuzz/mutanalysis.sh ${{ inputs.iters }} ${{ inputs.skip }}
      - uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: mutanalysis_${{ inputs.iters }}_${{ inputs.skip }}
          path: |
            /out
