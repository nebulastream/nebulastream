name: NES Nightly

# This workflow is triggered every night at 2:30 AM UTC.
# This is a good way to ensure that the main branch is always in a good state.
# For now, this workflow file runs the same tests as `pr.yml` and then creates a docker image nes-executable-image:nightly, if the test pass.
# For pushing an image to the docker hub, we build debian packages (nes-amd64.deb and nes-arm64.deb) and then use them to build the docker image.
# We will add long-running test for stability and performance checks in the future.

on:
  workflow_dispatch:
  schedule:
    - cron: '30 2 * * *' # gets executed every night at 4:30 AM CEST

jobs:
  fetch-current-main-commit:
    runs-on: [ self-hosted ]
    outputs:
      sha: ${{ steps.fetch-sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v4
      - name: Fetch SHA
        id: fetch-sha
        run: |
          git rev-parse --verify HEAD
          echo "sha=$(git rev-parse --verify HEAD)" >> "$GITHUB_OUTPUT"

  get-dev-images:
    needs: fetch-current-main-commit
    uses: ./.github/workflows/get_dev_images.yml
    secrets: inherit
    with:
      ref: ${{ needs.fetch-current-main-commit.outputs.sha }}

  full-clang-tidy:
    needs: [ fetch-current-main-commit, get-dev-images ]
    uses: ./.github/workflows/clang_tidy_full.yml
    secrets: inherit
    with:
      ref: ${{ needs.fetch-current-main-commit.outputs.sha }}
      dev_image_tag: ${{ needs.get-dev-images.outputs.image-tag }}

  compile-time-regression:
    needs: [ fetch-current-main-commit, get-dev-images ]
    uses: ./.github/workflows/compile_time_regression.yml
    secrets: inherit
    with:
      ref: ${{ needs.fetch-current-main-commit.outputs.sha }}
      dev_image_tag: ${{ needs.get-dev-images.outputs.image-tag }}

  build-and-test:
    name: "Run build and test"
    needs: [ fetch-current-main-commit, get-dev-images ]
    uses: ./.github/workflows/build_and_test.yml
    with:
      ref: ${{ needs.fetch-current-main-commit.outputs.sha }}
      dev_image_tag: ${{ needs.get-dev-images.outputs.image-tag }}

  # This is a placeholder for adding long-running tests in the future. Currently, it simply prints a message.
  long-running-tests:
    needs: [ build-and-test ]
    runs-on: [ self-hosted, linux, X64, Build ]
    steps:
      - name: Print Placeholder Message
        run: echo "Long running tests will be added in the future."

  create-nightly-image:
    needs: [ build-and-test ]
    if: ${{ !github.event.act }}
    uses: ./.github/workflows/create_release_image.yml
    secrets: inherit
    with:
      ref: "main"
      dockerhub-tag: "nightly"
