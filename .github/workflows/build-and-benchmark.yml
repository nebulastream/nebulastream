name: Build, Run and Benchmark Systests
on:
  workflow_call:
        inputs:
          run_reason:
            required: true
            type: string
            description: "Reason why benchmark suite is being run"
          ref:
            type: string
            required: true
            description: "ref of the branch"
          dev_image_tag:
            required: true
            type: string
            description: "Docker image tag of the benchmarking image"

jobs:
  build-and-benchmark:
    runs-on: [ self-hosted, linux, Build ]
    container:
      image: nebulastream/nes-benchmark:${{ inputs.dev_image_tag }}
      volumes:
        - ccache:/ccache
      env:
        CCACHE_DIR: /ccache
        MOLD_JOBS: 1
        CONBENCH_PROJECT_COMMIT: ${{ inputs.ref }}
        CONBENCH_URL: "https://bench.nebula.stream"
        CONBENCH_EMAIL: ${{ secrets.CONBENCH_USR }}
        CONBENCH_PASSWORD: ${{ secrets.CONBENCH_PWD }}
        CONBENCH_PROJECT_REPOSITORY: "https://github.com/${{ github.repository }}"
        CONBENCH_RUN_REASON: ${{ inputs.run_reason }}
        CONBENCH_MACHINE_INFO_NAME: "Github Runner"
      options: --user root
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
      - name: build systest
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-march=native -mtune=native -O3" \
            -DCMAKE_C_FLAGS="-march=native -mtune=native -O3"
          cmake --build build --target systest -j -- -k 0
      - name: run Benchmarks
        run: |
          ./build/nes-systests/systest/systest -b -- --worker.numberOfBuffersInGlobalBufferManager=20000 
          python3 ./scripts/benchmarking/benchmark.py --systest

