name: Build, Run and Benchmark Systests
on:
  pull_request:

jobs:
  fetch-current-main-commit:
    runs-on: [ self-hosted ]
    outputs:
      sha: ${{ steps.fetch-sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'testing-conbench-hotfix'
      - name: Fetch SHA
        id: fetch-sha
        run: |
          git rev-parse --verify HEAD
          echo "sha=$(git rev-parse --verify HEAD)" >> "$GITHUB_OUTPUT"

  get-dev-images:
    needs: fetch-current-main-commit
    uses: ./.github/workflows/get_dev_images.yml
    secrets: inherit
    with:
      ref: ${{ needs.fetch-current-main-commit.outputs.sha }}

  build-and-benchmark:
    needs: [ fetch-current-main-commit, get-dev-images ]
    runs-on: bc58-nes-public
    container:
      image: nebulastream/nes-benchmark:${{ needs.get-dev-images.outputs.image-tag }}
      volumes:
        - ccache:/ccache
        - test-file-cache:/test-file-cache
      env:
        CCACHE_DIR: /ccache
        MOLD_JOBS: 1
        CONBENCH_PROJECT_COMMIT: ${{ needs.fetch-current-main-commit.outputs.sha }}
        CONBENCH_URL: "https://bench.nebula.stream"
        CONBENCH_EMAIL: ${{ secrets.CONBENCH_USR }}
        CONBENCH_PASSWORD: ${{ secrets.CONBENCH_PWD }}
        CONBENCH_PROJECT_REPOSITORY: "https://github.com/${{ github.repository }}"
        CONBENCH_RUN_REASON: "Tesing conbench hotfix"
        CONBENCH_MACHINE_INFO_NAME: "Github Runner"
      options: --user root
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.fetch-current-main-commit.outputs.sha }}
      - name: build systest
        run: |
          cmake -GNinja -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_LARGE_TESTS=ON -DExternalData_OBJECT_STORES=/test-file-cache
          cmake --build build -j
      - name: run Benchmarks
        run: |
          ./build/nes-systests/systest/systest -b -g benchmark -- --worker.numberOfBuffersInGlobalBufferManager=20000 
          python3 ./scripts/benchmarking/benchmark.py --systest

