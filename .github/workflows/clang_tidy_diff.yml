name: Clang-Tidy-Diff
description: |
  This workflow computes the clang-tidy check for the git diff between base and head.
  we generate GitHub PR annotations based on the output of clang-tidy if this workflow was called within the context
  of a pr.
on:
  workflow_call:
    inputs:
      dev_image_tag:
        required: true
        type: string
        description: "Docker image tag of the development image"
      head_sha:
        type: string
        required: true
        description: "commit sha of head"
      base_sha:
        type: string
        required: true
        description: "commit sha of base"
      number_of_commits:
        type: number
        required: false
        default: -1

  # We need to use pull_request to run this workflow starting from our base repo and pull_request_target to run this
  # workflow in our base repo (but starting from a fork), as clang-tidy-pr-comments needs 'write' permissions to our repo. This is solely possible
  # with pull_request_target as pull_request provides 'read' permissions.
  pull_request:
    types: [ opened, synchronize, reopened ]
  pull_request_target:
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}-clang-tidy-diff
  cancel-in-progress: true

jobs:
  get-dev-images:
    uses: ./.github/workflows/get_dev_images.yml
    secrets: inherit
    with:
      branch-name: ${{ github.head_ref }}
      head_sha: ${{ github.event.pull_request.head.sha }}

  setup:
    needs: [get-dev-images]
    name: Setup inputs
    runs-on: ubuntu-latest
    outputs:
      dev_image_tag: ${{ steps.set_vars.outputs.dev_image_tag }}
      head_sha: ${{ steps.set_vars.outputs.head_sha }}
      base_sha: ${{ steps.set_vars.outputs.base_sha }}
      number_of_commits: ${{ steps.set_vars.outputs.number_of_commits }}
    steps:
      - name: Set workflow inputs
        id: set_vars
        run: |
          # If this workflow is called via workflow_call, we want to use the inputs.
          # Otherwise, we want to use "default" values
          if [[ "${{ github.event_name }}" == "pull_request" || "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "Running in PR context"
            echo "dev_image_tag=${{ needs.get-dev-images.outputs.image-tag }}" >> $GITHUB_OUTPUT
            echo "head_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
            echo "base_sha=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "number_of_commits=${{ github.event.pull_request.commits || -1 }}" >> $GITHUB_OUTPUT
          else
            echo "Running in workflow_call or non-PR context"
            echo "dev_image_tag=${{ inputs.dev_image_tag }}" >> $GITHUB_OUTPUT
            echo "head_sha=${{ inputs.head_sha || github.sha }}" >> $GITHUB_OUTPUT
            echo "base_sha=${{ inputs.base_sha || github.event.before || github.sha }}" >> $GITHUB_OUTPUT
            echo "number_of_commits=${{ inputs.number_of_commits || -1 }}" >> $GITHUB_OUTPUT
          fi

  check-clang-tidy:
    timeout-minutes: 90
    name: Clang-Tidy Diff
    needs: [setup, get-dev-images]
    runs-on: ${{ matrix.runner }}
    if: >
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.fork == true) ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false)
    strategy:
      matrix:
        arch: [ x64 ]
        stdlib: [ 'libcxx' ]
        sanitizer: [ 'none' ]
        build_type: [ 'Debug' ]
        include:
          - arch: x64
            runner: [ "ubuntu-24.04" ]
    steps:
      - name: Include base commit
        id: increment
        run: echo "result=$((${{ needs.setup.outputs.number_of_commits }} + 1))" >> $GITHUB_OUTPUT
      - name: Checkout Branch
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ steps.increment.outputs.result }}
          ref: ${{ needs.setup.outputs.head_sha }}
      - uses: ./.github/steps/prepare-github
        with:
          image_name: nebulastream/nes-ci:${{ needs.setup.outputs.dev_image_tag }}-${{ matrix.stdlib }}-${{matrix.sanitizer}}
          ccache_key: ${{ matrix.arch }}-${{ matrix.build_type }}-${{matrix.sanitizer}}-${{matrix.stdlib}}
      - uses: ./.github/steps/run-in-container
        name: CMake Build
        with:
          image_name: nebulastream/nes-ci:${{ needs.setup.outputs.dev_image_tag }}-${{ matrix.stdlib }}-${{matrix.sanitizer}}
          run: |
            source .github/.env/test-${{matrix.sanitizer}}.env
            cmake -GNinja -B build -DUSE_SANITIZER=${{ matrix.sanitizer }} -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DNES_LOG_LEVEL=DEBUG
            # We need to build the project, as some headers are only created during the build.
            cmake --build build -j  -- -k 0
      - name: Create results directory
        run: mkdir clang-tidy-result
      - uses: ./.github/steps/run-in-container
        name: Run Clang Tidy Pre-check
        with:
          image_name: nebulastream/nes-ci:${{ needs.setup.outputs.dev_image_tag }}-${{ matrix.stdlib }}-${{matrix.sanitizer}}
          run: |
            git diff -U0 ${{ needs.setup.outputs.base_sha }} -- ':!*.inc' | clang-tidy-diff-19.py -clang-tidy-binary clang-tidy-19 -p1 -path build -export-fixes clang-tidy-result/fixes.yml  -checks='-*,readability-duplicate-include' -j $(nproc)
      - uses: ./.github/steps/run-in-container
        name: Run Clang Tidy with all Checks
        with:
          image_name: nebulastream/nes-ci:${{ needs.setup.outputs.dev_image_tag }}-${{ matrix.stdlib }}-${{matrix.sanitizer}}
          run: |
            git diff -U0 ${{ needs.setup.outputs.base_sha }} -- ':!*.inc' | clang-tidy-diff-19.py -clang-tidy-binary clang-tidy-19 -p1 -path build -export-fixes clang-tidy-result/fixes.yml -j $(nproc)
      - name: Upload Clang-Tidy Results
        if: ${{ !cancelled() && !github.event.act }}
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: warn
          name: clang-tidy-result
          path: clang-tidy-result
      - name: Run clang-tidy-pr-comments action
        if: ${{ !cancelled() && github.event_name == 'pull_request' }}
        # requires python3-venv
        uses: platisd/clang-tidy-pr-comments@v1
        with:
          github_token: ${{ github.token }}
          clang_tidy_fixes: clang-tidy-result/fixes.yml
          request_changes: false
          # Optionally set the number of comments per review to avoid GitHub API timeouts for heavily loaded pull requests
          suggestions_per_comment: 100
          auto_resolve_conversations: true
          python_path: /usr/bin/python3
