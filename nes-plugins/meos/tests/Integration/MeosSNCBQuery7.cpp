/*
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        https://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
*/

#include <API/Expressions/ArithmeticalExpressions.hpp>
#include <API/Expressions/Expressions.hpp>
#include <API/Windowing.hpp>
#include <API/QueryAPI.hpp>
#include <API/TestSchemas.hpp>
#include <BaseIntegrationTest.hpp>
#include <Catalogs/Source/PhysicalSource.hpp>
#include <Catalogs/Topology/Topology.hpp>
#include <Common/DataTypes/DataTypeFactory.hpp>
#include <Configurations/Worker/PhysicalSourceTypes/CSVSourceType.hpp>
#include <Configurations/Worker/WorkerConfiguration.hpp>
#include <Nautilus/Interface/Record.hpp>
#include <Runtime/TupleBuffer.hpp>
#include <Services/RequestHandlerService.hpp>
#include <Util/Logger/Logger.hpp>
#include <Util/TestHarness/TestHarness.hpp>

#include <cstdint>
#include <gmock/gmock.h>
#include <gtest/gtest.h>

#include <Execution/Operators/MEOS/Meos.hpp>
#include <nlohmann/json.hpp> 


struct InputValue {
    uint64_t timestamp;
    uint64_t id;
    double speed;
    double latitude;
    double longitude;
};



namespace NES {
using namespace Configurations;

void exportToJson(const std::vector<NES::Runtime::MemoryLayouts::TestTupleBuffer>& actualBuffers,
                  const std::string& outputPath) {
    nlohmann::json jsonData = nlohmann::json::array();
    for (const auto& buffer : actualBuffers) {
        size_t numTuples = buffer.getNumberOfTuples();
        for (size_t i = 0; i < numTuples; ++i) {
            auto tuple = buffer[i];
            // Adjust fields as needed
            nlohmann::json row;
            row["timestamp"] = tuple[0].read<uint64_t>();
            row["id"]   = tuple[1].read<uint64_t>();
            row["speed"]    = tuple[2].read<double>();
            row["latitude"]    = tuple[3].read<double>();
            row["longitude"]    = tuple[4].read<double>();
            jsonData.push_back(row);
        }
    }
    std::ofstream outFile(outputPath);
    outFile << jsonData.dump(2);
    outFile.close();
}

void exportToCsv(const std::vector<NES::Runtime::MemoryLayouts::TestTupleBuffer>& actualBuffers,
                 const std::string& outputPath) {
    std::ofstream outFile(outputPath);
    
    // Write CSV header
    outFile << "timestamp,id,speed,latitude,longitude\n";
    
    // Write data rows
    for (const auto& buffer : actualBuffers) {
        size_t numTuples = buffer.getNumberOfTuples();
        for (size_t i = 0; i < numTuples; ++i) {
            auto tuple = buffer[i];
            outFile << tuple[0].read<uint64_t>() << ","   // timestamp
                   << tuple[1].read<uint64_t>() << ","   // id
                   << tuple[2].read<double>() << ","     // speed
                   << tuple[3].read<double>() << ","     // latitude
                   << tuple[4].read<double>() << "\n";   // longitude
        }
    }
    outFile.close();
}

class ReadSNCB : public Testing::BaseIntegrationTest,
                   public testing::WithParamInterface<std::tuple<std::string, SchemaPtr, std::string, std::string>> {
  protected:
    WorkerConfigurationPtr workerConfiguration;

    static void SetUpTestCase() {
        NES::Logger::setupLogging("meos.log", NES::LogLevel::LOG_DEBUG);
        NES_INFO("Setup SNCB test class.");
    }

    void SetUp() override {
        Testing::BaseIntegrationTest::SetUp();
        workerConfiguration = WorkerConfiguration::create();
        workerConfiguration->queryCompiler.windowingStrategy = QueryCompilation::WindowingStrategy::SLICING;
        workerConfiguration->queryCompiler.compilationStrategy = QueryCompilation::CompilationStrategy::DEBUG;
    }
};

/**
 * @brief Tests creating a meos instance, reading from a CSV, and verifying intersection functionality.
 */
TEST_F(ReadSNCB, testReadCSV) {
    using namespace MEOS;
    try {
        // Initialize MEOS instance
        MEOS::Meos* meos = new MEOS::Meos("UTC");
        auto workerConfiguration1 = WorkerConfiguration::create();


        auto gpsSchema = Schema::create()
                ->addField("timestamp", BasicType::UINT64)
                ->addField("id", BasicType::UINT64)
                ->addField("speed", BasicType::FLOAT64)
                ->addField("latitude", BasicType::FLOAT64)
                ->addField("longitude", BasicType::FLOAT64);
                              
                              

        ASSERT_EQ(sizeof(InputValue), gpsSchema->getSchemaSizeInBytes());

        auto csvSourceType = CSVSourceType::create("gps", "dfgps_time");
        csvSourceType->setFilePath(std::filesystem::path(TEST_DATA_DIRECTORY) / "dfgps_time.csv");
        csvSourceType->setNumberOfTuplesToProducePerBuffer(36);    
        csvSourceType->setGatheringInterval(0);                      
        csvSourceType->setNumberOfBuffersToProduce(100);
        csvSourceType->setSkipHeader(true);                   // Skip the header

        /* Query Unscheduled Stops
        The system compares the train’s real-time GPS location with known station and workshop zones. 
        If the train’s status is stopped outside these zones, the stop is flagged as unscheduled.
        This alert helps operators act fast, whether they need to send help, investigate mechanical problems, 
        or address other safety concerns. It also prevents unauthorized halts that could disrupt the timetable and affect service reliability.*/

        auto subQueryA = Query::from("gps")
                    .filter(tpointatsworkshop(Attribute("longitude", BasicType::FLOAT64),
                                              Attribute("latitude", BasicType::FLOAT64),
                                              Attribute("timestamp", BasicType::UINT64)) == 0);

                        
        auto query = Query::from("gps")
                    .filter(Attribute("speed") < 0.002)
                    .andWith(subQueryA)
                    .window(SlidingWindow::of(EventTime(Attribute("timestamp", BasicType::UINT64)), 
                                        Seconds(30), Seconds(30)))
                    .project(
                        Attribute("timestamp"),
                        Attribute("id"),
                        Attribute("speed"),
                        Attribute("longitude"),
                        Attribute("latitude")                   
                    );

                    
    
        // Create the Test Harness and Attach CSV Sources
        auto testHarness = TestHarness(query, *restPort, *rpcCoordinatorPort, getTestResourceFolder())
            .addLogicalSource("gps", gpsSchema)
            .attachWorkerWithLambdaSourceToCoordinator(csvSourceType, workerConfiguration1);

        testHarness.validate().setupTopology();

        // Define expected output
        const auto expectedOutput = "1719784719,5,0.0037,4.442,51.2243\n"
                                                        "1719784728,2,0.0204,5.3106,50.9353\n"
                                                        "1719784729,5,0.037,4.442,51.2243\n"
                                                        "1719784738,2,0.0166,5.3106,50.9353\n"
                                                        "1719784739,5,0.0037,4.442,51.2243\n"
                                                        "1719784748,2,0.074,5.3106,50.9353\n"
                                                        "1719784749,5,0.0407,4.442,51.2243\n"
                                                        "1719784753,8,0.0444,4.3116,50.8148\n"
                                                        "1719784758,2,0.0166,5.3106,50.9353\n"
                                                        "1719784760,5,0.0241,4.442,51.2243\n"
                                                        "1719784763,8,0.0574,4.3116,50.8148\n"
                                                        "1719784768,2,0.0592,5.3106,50.9353\n"
                                                        "1719784770,5,0.0426,4.442,51.2243\n"
                                                        "1719784773,8,0.0592,4.3115,50.8148\n"
                                                        "1719784775,9,2.3995,4.3409,50.8356\n"
                                                        "1719784778,2,0.037,5.3106,50.9353\n"
                                                        "1719784783,8,0.0796,4.3115,50.8148\n"
                                                        "1719784785,9,1.6465,4.3408,50.8356\n"
                                                        "1719784788,2,0.0352,5.3106,50.9353\n"
                                                        "1719784790,5,0.0333,4.442,51.2243\n"
                                                        "1719784793,8,0.0814,4.3115,50.8148\n"
                                                        "1719784795,9,1.2913,4.3409,50.8356\n"
                                                        "1719784798,2,0.0352,5.3106,50.9353\n"
                                                        "1719784851,9,2.8509,4.3409,50.8356\n"
                                                        "1719784851,9,2.2866,4.3409,50.8356\n"
                                                        "1719784852,9,1.5004,4.3409,50.8356\n"
                                                        "1719784856,5,0.0426,4.442,51.2243\n"
                                                        "1719784856,2,0.0352,5.3106,50.9353\n"
                                                        "1719784857,2,0.037,5.3106,50.9353\n"
                                                        "1719784858,2,0.0222,5.3106,50.9353\n"
                                                        "1719784860,9,2.2293,4.3408,50.8355\n"
                                                        "1719784863,2,0.0204,5.3106,50.9353\n"
                                                        "1719784864,5,0.0222,4.442,51.2243\n"
                                                        "1719784870,9,1.6354,4.3408,50.8356\n"
                                                        "1719784870,8,0.037,4.3115,50.8148\n"
                                                        "1719784870,8,0.0703,4.3115,50.8148\n"
                                                        "1719784872,8,0.0444,4.3115,50.8148\n"
                                                        "1719784873,2,0.0278,5.3106,50.9353\n"
                                                        "1719784874,5,0.0278,4.442,51.2243\n"
                                                        "1719784874,8,0.0944,4.3115,50.8148\n"
                                                        "1719784880,9,1.3931,4.3409,50.8357\n"
                                                        "1719784883,2,0.0019,5.3106,50.9353\n"
                                                        "1719784884,5,0.0241,4.442,51.2243\n"
                                                        "1719784885,8,0.0555,4.3115,50.8148\n"
                                                        "1719784890,9,3.6353,4.3411,50.8359\n"
                                                        "1719784893,2,0.0296,5.3106,50.9353\n"
                                                        "1719784894,5,0.0389,4.442,51.2243\n"
                                                        "1719784895,8,0.0426,4.3115,50.8148\n"
                                                        "1719784901,9,1.8907,4.3411,50.8359\n"
                                                        "1719784903,2,0.0352,5.3106,50.9353\n"
                                                        "1719784904,8,0.013,4.3115,50.8148\n"
                                                        "1719784904,5,0.0444,4.442,51.2243\n"
                                                        "1719784911,9,1.8334,4.3411,50.8359\n"
                                                        "1719784913,2,0.05,5.3106,50.9353\n"
                                                        "1719784914,5,0.0333,4.442,51.2243\n"
                                                        "1719784914,8,0.0611,4.3115,50.8148\n"
                                                        "1719784923,2,0.037,5.3106,50.9353\n"
                                                        "1719784924,5,0.0352,4.442,51.2243\n"
                                                        "1719784924,8,0.0185,4.3115,50.8148\n"
                                                        "1719784933,2,0.0315,5.3106,50.9353\n"
                                                        "1719784934,5,0.0352,4.442,51.2243\n"
                                                        "1719784934,8,0.0389,4.3116,50.8148\n"
                                                        "1719784943,2,0.0056,5.3106,50.9353\n"
                                                        "1719784944,5,0.013,4.442,51.2243\n"
                                                        "1719784944,8,0.05,4.3116,50.8148\n"
                                                        "1719784951,9,0.4477,4.3409,50.8358\n"
                                                        "1719784953,2,0.0426,5.3106,50.9353\n"
                                                        "1719784954,5,0.0093,4.442,51.2243\n"
                                                        "1719784955,8,0.0222,4.3116,50.8148\n"
                                                        "1719784961,9,1.0915,4.3409,50.8357\n"
                                                        "1719784963,2,0.0444,5.3106,50.9353\n"
                                                        "1719784965,8,0.0148,4.3115,50.8148\n"
                                                        "1719784965,5,0.0296,4.442,51.2243\n"
                                                        "1719784971,9,0.1758,4.3409,50.8357\n"
                                                        "1719784973,2,0.0481,5.3106,50.9353\n"
                                                        "1719784975,8,0.0166,4.3115,50.8148\n"
                                                        "1719784975,5,0.013,4.442,51.2243\n"
                                                        "1719784981,9,0.7104,4.3408,50.8357\n"
                                                        "1719784984,2,0.0648,5.3106,50.9353\n"
                                                        "1719784991,9,0.124,4.3408,50.8357\n"
                                                        "1719784994,2,0.0333,5.3106,50.9353\n"
                                                        "1719784995,5,0.0166,4.442,51.2243\n"
                                                        "1719785001,9,0.9472,4.3407,50.8356\n"
                                                        "1719785004,2,0.0241,5.3106,50.9353\n"
                                                        "1719785005,8,0.037,4.3115,50.8147\n"
                                                        "1719785005,5,0.0185,4.442,51.2243\n"
                                                        "1719785011,9,0.1406,4.3407,50.8356\n"
                                                        "1719785014,2,0.037,5.3106,50.9353\n"
                                                        "1719785015,8,0.0241,4.3115,50.8148\n"
                                                        "1719785015,5,0.0056,4.442,51.2243\n"
                                                        "1719785021,9,0.0759,4.3407,50.8356\n"
                                                        "1719785025,5,0.0444,4.442,51.2243\n"
                                                        "1719785025,8,0.0185,4.3115,50.8148\n"
                                                        "1719785031,9,0.3867,4.3407,50.8356\n"
                                                        "1719785035,8,0.0111,4.3115,50.8148\n"
                                                        "1719785041,9,1.1988,4.3409,50.8357\n"
                                                        "1719785044,2,0.0148,5.3106,50.9353\n"
                                                        "1719785045,8,0.0019,4.3115,50.8148\n"
                                                        "1719785051,9,0.3959,4.3409,50.8357\n"
                                                        "1719785055,8,0.0426,4.3115,50.8148\n"
                                                        "1719785055,5,0.0296,4.442,51.2243\n"
                                                        "1719785061,9,0.7012,4.3408,50.8357\n"
                                                        "1719785065,8,0.0259,4.3115,50.8148\n"
                                                        "1719785065,5,0.0111,4.442,51.2243\n"
                                                        "1719785071,9,0.7789,4.3409,50.8358\n"
                                                        "1719785074,2,0.0518,5.3106,50.9353\n"
                                                        "1719785075,5,0.0444,4.442,51.2243\n"
                                                        "1719785075,8,0.0426,4.3115,50.8148\n"
                                                        "1719785081,9,2.4383,4.3409,50.8358\n"
                                                        "1719785084,2,0.0185,5.3106,50.9353\n"
                                                        "1719785085,8,0.0925,4.3115,50.8148\n"
                                                        "1719785085,5,0.0481,4.442,51.2243\n"
                                                        "1719785091,9,0.2035,4.3409,50.8358\n"
                                                        "1719785094,2,0.0426,5.3106,50.9353\n"
                                                        "1719785095,8,0.0944,4.3115,50.8148\n"
                                                        "1719785095,5,0.0222,4.442,51.2243\n"
                                                        "1719785101,9,0.9306,4.3409,50.8357\n"
                                                        "1719785104,2,0.0389,5.3106,50.9353\n"
                                                        "1719785105,5,0.0259,4.442,51.2243\n"
                                                        "1719785105,8,0.0222,4.3115,50.8148\n"
                                                        "1719785111,9,3.1709,4.3408,50.8357\n"
                                                        "1719785114,2,0.0222,5.3106,50.9353\n"
                                                        "1719785115,8,0.0241,4.3115,50.8148\n"
                                                        "1719785115,5,0.0315,4.442,51.2243\n"
                                                        "1719785121,9,0.494,4.3408,50.8357\n"
                                                        "1719785124,2,0.0204,5.3106,50.9353\n"
                                                        "1719785125,5,0.0166,4.442,51.2243\n"
                                                        "1719785125,8,0.0666,4.3115,50.8148\n"
                                                        "1719785132,9,0.4607,4.3408,50.8357\n"
                                                        "1719785134,2,0.0074,5.3106,50.9353\n"
                                                        "1719785135,5,0.0204,4.442,51.2243\n"
                                                        "1719785135,8,0.0333,4.3115,50.8148\n"
                                                        "1719785144,2,0.0093,5.3106,50.9353\n"
                                                        "1719785145,8,0.0518,4.3115,50.8148\n"
                                                        "1719785145,5,0.0981,4.442,51.2243\n"
                                                        "1719785154,2,0.0315,5.3106,50.9353\n"
                                                        "1719785155,5,0.0056,4.442,51.2243\n"
                                                        "1719785155,8,0.013,4.3115,50.8148\n"
                                                        "1719785164,2,0.0093,5.3106,50.9353\n"
                                                        "1719785165,5,0.0666,4.442,51.2243\n"
                                                        "1719785166,8,0.0278,4.3115,50.8148\n"
                                                        "1719785174,2,0.0333,5.3106,50.9353\n"
                                                        "1719785175,5,0.013,4.442,51.2243\n"
                                                        "1719785176,8,0.0315,4.3115,50.8148\n"
                                                        "1719785184,2,0.0296,5.3106,50.9353\n"
                                                        "1719785185,5,0.0259,4.442,51.2243\n"
                                                        "1719785194,2,0.0222,5.3106,50.9353\n"
                                                        "1719785196,5,0.074,4.442,51.2243\n"
                                                        "1719785196,8,0.0278,4.3115,50.8148\n"
                                                        "1719785202,9,2.0128,4.341,50.8358\n"
                                                        "1719785204,2,0.0222,5.3106,50.9353\n"
                                                        "1719785206,5,0.0019,4.442,51.2243\n"
                                                        "1719785206,8,0.0166,4.3115,50.8148\n"
                                                        "1719785212,9,1.369,4.3409,50.8358\n"
                                                        "1719785214,2,0.0407,5.3106,50.9353\n"
                                                        "1719785216,5,0.0166,4.442,51.2243\n"
                                                        "1719785216,8,0.0352,4.3116,50.8148\n"
                                                        "1719785222,9,1.7649,4.3408,50.8357\n"
                                                        "1719784719,5,0.0037,4.442,51.2243\n"
                                                        "1719784728,2,0.0204,5.3106,50.9353\n"
                                                        "1719784729,5,0.037,4.442,51.2243\n"
                                                        "1719784738,2,0.0166,5.3106,50.9353\n"
                                                        "1719784739,5,0.0037,4.442,51.2243\n"
                                                        "1719784748,2,0.074,5.3106,50.9353\n"
                                                        "1719784749,5,0.0407,4.442,51.2243\n"
                                                        "1719784753,8,0.0444,4.3116,50.8148\n"
                                                        "1719784758,2,0.0166,5.3106,50.9353\n"
                                                        "1719784760,5,0.0241,4.442,51.2243\n"
                                                        "1719784763,8,0.0574,4.3116,50.8148\n"
                                                        "1719784768,2,0.0592,5.3106,50.9353\n"
                                                        "1719784770,5,0.0426,4.442,51.2243\n"
                                                        "1719784773,8,0.0592,4.3115,50.8148\n"
                                                        "1719784775,9,2.3995,4.3409,50.8356\n"
                                                        "1719784778,2,0.037,5.3106,50.9353\n"
                                                        "1719784783,8,0.0796,4.3115,50.8148\n"
                                                        "1719784785,9,1.6465,4.3408,50.8356\n"
                                                        "1719784788,2,0.0352,5.3106,50.9353\n"
                                                        "1719784790,5,0.0333,4.442,51.2243\n"
                                                        "1719784793,8,0.0814,4.3115,50.8148\n"
                                                        "1719784795,9,1.2913,4.3409,50.8356\n"
                                                        "1719784798,2,0.0352,5.3106,50.9353\n"
                                                        "1719784851,9,2.8509,4.3409,50.8356\n"
                                                        "1719784851,9,2.2866,4.3409,50.8356\n"
                                                        "1719784852,9,1.5004,4.3409,50.8356\n"
                                                        "1719784856,5,0.0426,4.442,51.2243\n"
                                                        "1719784856,2,0.0352,5.3106,50.9353\n"
                                                        "1719784857,2,0.037,5.3106,50.9353\n"
                                                        "1719784858,2,0.0222,5.3106,50.9353\n"
                                                        "1719784860,9,2.2293,4.3408,50.8355\n"
                                                        "1719784863,2,0.0204,5.3106,50.9353\n"
                                                        "1719784864,5,0.0222,4.442,51.2243\n"
                                                        "1719784870,9,1.6354,4.3408,50.8356\n"
                                                        "1719784870,8,0.037,4.3115,50.8148\n"
                                                        "1719784870,8,0.0703,4.3115,50.8148\n"
                                                        "1719784872,8,0.0444,4.3115,50.8148\n"
                                                        "1719784873,2,0.0278,5.3106,50.9353\n"
                                                        "1719784874,5,0.0278,4.442,51.2243\n"
                                                        "1719784874,8,0.0944,4.3115,50.8148\n"
                                                        "1719784880,9,1.3931,4.3409,50.8357\n"
                                                        "1719784883,2,0.0019,5.3106,50.9353\n"
                                                        "1719784884,5,0.0241,4.442,51.2243\n"
                                                        "1719784885,8,0.0555,4.3115,50.8148\n"
                                                        "1719784890,9,3.6353,4.3411,50.8359\n"
                                                        "1719784893,2,0.0296,5.3106,50.9353\n"
                                                        "1719784894,5,0.0389,4.442,51.2243\n"
                                                        "1719784895,8,0.0426,4.3115,50.8148\n"
                                                        "1719784901,9,1.8907,4.3411,50.8359\n"
                                                        "1719784903,2,0.0352,5.3106,50.9353\n"
                                                        "1719784904,8,0.013,4.3115,50.8148\n"
                                                        "1719784904,5,0.0444,4.442,51.2243\n"
                                                        "1719784911,9,1.8334,4.3411,50.8359\n"
                                                        "1719784913,2,0.05,5.3106,50.9353\n"
                                                        "1719784914,5,0.0333,4.442,51.2243\n"
                                                        "1719784914,8,0.0611,4.3115,50.8148\n"
                                                        "1719784923,2,0.037,5.3106,50.9353\n"
                                                        "1719784924,5,0.0352,4.442,51.2243\n"
                                                        "1719784924,8,0.0185,4.3115,50.8148\n"
                                                        "1719784933,2,0.0315,5.3106,50.9353\n"
                                                        "1719784934,5,0.0352,4.442,51.2243\n"
                                                        "1719784934,8,0.0389,4.3116,50.8148\n"
                                                        "1719784943,2,0.0056,5.3106,50.9353\n"
                                                        "1719784944,5,0.013,4.442,51.2243\n"
                                                        "1719784944,8,0.05,4.3116,50.8148\n"
                                                        "1719784951,9,0.4477,4.3409,50.8358\n"
                                                        "1719784953,2,0.0426,5.3106,50.9353\n"
                                                        "1719784954,5,0.0093,4.442,51.2243\n"
                                                        "1719784955,8,0.0222,4.3116,50.8148\n"
                                                        "1719784961,9,1.0915,4.3409,50.8357\n"
                                                        "1719784963,2,0.0444,5.3106,50.9353\n"
                                                        "1719784965,8,0.0148,4.3115,50.8148\n"
                                                        "1719784965,5,0.0296,4.442,51.2243\n"
                                                        "1719784971,9,0.1758,4.3409,50.8357\n"
                                                        "1719784973,2,0.0481,5.3106,50.9353\n"
                                                        "1719784975,8,0.0166,4.3115,50.8148\n"
                                                        "1719784975,5,0.013,4.442,51.2243\n"
                                                        "1719784981,9,0.7104,4.3408,50.8357\n"
                                                        "1719784984,2,0.0648,5.3106,50.9353\n"
                                                        "1719784991,9,0.124,4.3408,50.8357\n"
                                                        "1719784994,2,0.0333,5.3106,50.9353\n"
                                                        "1719784995,5,0.0166,4.442,51.2243\n"
                                                        "1719785001,9,0.9472,4.3407,50.8356\n"
                                                        "1719785004,2,0.0241,5.3106,50.9353\n"
                                                        "1719785005,8,0.037,4.3115,50.8147\n"
                                                        "1719785005,5,0.0185,4.442,51.2243\n"
                                                        "1719785011,9,0.1406,4.3407,50.8356\n"
                                                        "1719785014,2,0.037,5.3106,50.9353\n"
                                                        "1719785015,8,0.0241,4.3115,50.8148\n"
                                                        "1719785015,5,0.0056,4.442,51.2243\n"
                                                        "1719785021,9,0.0759,4.3407,50.8356\n"
                                                        "1719785025,5,0.0444,4.442,51.2243\n"
                                                        "1719785025,8,0.0185,4.3115,50.8148\n"
                                                        "1719785031,9,0.3867,4.3407,50.8356\n"
                                                        "1719785035,8,0.0111,4.3115,50.8148\n"
                                                        "1719785041,9,1.1988,4.3409,50.8357\n"
                                                        "1719785044,2,0.0148,5.3106,50.9353\n"
                                                        "1719785045,8,0.0019,4.3115,50.8148\n"
                                                        "1719785051,9,0.3959,4.3409,50.8357\n"
                                                        "1719785055,8,0.0426,4.3115,50.8148\n"
                                                        "1719785055,5,0.0296,4.442,51.2243\n"
                                                        "1719785061,9,0.7012,4.3408,50.8357\n"
                                                        "1719785065,8,0.0259,4.3115,50.8148\n"
                                                        "1719785065,5,0.0111,4.442,51.2243\n"
                                                        "1719785071,9,0.7789,4.3409,50.8358\n"
                                                        "1719785074,2,0.0518,5.3106,50.9353\n"
                                                        "1719785075,5,0.0444,4.442,51.2243\n"
                                                        "1719785075,8,0.0426,4.3115,50.8148\n"
                                                        "1719785081,9,2.4383,4.3409,50.8358\n"
                                                        "1719785084,2,0.0185,5.3106,50.9353\n"
                                                        "1719785085,8,0.0925,4.3115,50.8148\n"
                                                        "1719785085,5,0.0481,4.442,51.2243\n"
                                                        "1719785091,9,0.2035,4.3409,50.8358\n"
                                                        "1719785094,2,0.0426,5.3106,50.9353\n"
                                                        "1719785095,8,0.0944,4.3115,50.8148\n"
                                                        "1719785095,5,0.0222,4.442,51.2243\n"
                                                        "1719785101,9,0.9306,4.3409,50.8357\n"
                                                        "1719785104,2,0.0389,5.3106,50.9353\n"
                                                        "1719785105,5,0.0259,4.442,51.2243\n"
                                                        "1719785105,8,0.0222,4.3115,50.8148\n"
                                                        "1719785111,9,3.1709,4.3408,50.8357\n"
                                                        "1719785114,2,0.0222,5.3106,50.9353\n"
                                                        "1719785115,8,0.0241,4.3115,50.8148\n"
                                                        "1719785115,5,0.0315,4.442,51.2243\n"
                                                        "1719785121,9,0.494,4.3408,50.8357\n"
                                                        "1719785124,2,0.0204,5.3106,50.9353\n"
                                                        "1719785125,5,0.0166,4.442,51.2243\n"
                                                        "1719785125,8,0.0666,4.3115,50.8148\n"
                                                        "1719785132,9,0.4607,4.3408,50.8357\n"
                                                        "1719785134,2,0.0074,5.3106,50.9353\n"
                                                        "1719785135,5,0.0204,4.442,51.2243\n"
                                                        "1719785135,8,0.0333,4.3115,50.8148\n"
                                                        "1719785144,2,0.0093,5.3106,50.9353\n"
                                                        "1719785145,8,0.0518,4.3115,50.8148\n"
                                                        "1719785145,5,0.0981,4.442,51.2243\n"
                                                        "1719785154,2,0.0315,5.3106,50.9353\n"
                                                        "1719785155,5,0.0056,4.442,51.2243\n"
                                                        "1719785155,8,0.013,4.3115,50.8148\n"
                                                        "1719785164,2,0.0093,5.3106,50.9353\n"
                                                        "1719785165,5,0.0666,4.442,51.2243\n"
                                                        "1719785166,8,0.0278,4.3115,50.8148\n"
                                                        "1719785174,2,0.0333,5.3106,50.9353\n"
                                                        "1719785175,5,0.013,4.442,51.2243\n"
                                                        "1719785176,8,0.0315,4.3115,50.8148\n"
                                                        "1719785184,2,0.0296,5.3106,50.9353\n"
                                                        "1719785185,5,0.0259,4.442,51.2243\n"
                                                        "1719785194,2,0.0222,5.3106,50.9353\n"
                                                        "1719785196,5,0.074,4.442,51.2243\n"
                                                        "1719785196,8,0.0278,4.3115,50.8148\n"
                                                        "1719785202,9,2.0128,4.341,50.8358\n"
                                                        "1719785204,2,0.0222,5.3106,50.9353\n"
                                                        "1719785206,5,0.0019,4.442,51.2243\n"
                                                        "1719785206,8,0.0166,4.3115,50.8148\n"
                                                        "1719785212,9,1.369,4.3409,50.8358\n"
                                                        "1719785214,2,0.0407,5.3106,50.9353\n"
                                                        "1719785216,5,0.0166,4.442,51.2243\n"
                                                        "1719785216,8,0.0352,4.3116,50.8148\n"
                                                        "1719785222,9,1.7649,4.3408,50.8357\n"
                                                        "1719784719,5,0.0037,4.442,51.2243\n"
                                                        "1719784728,2,0.0204,5.3106,50.9353\n"
                                                        "1719784729,5,0.037,4.442,51.2243\n"
                                                        "1719784738,2,0.0166,5.3106,50.9353\n"
                                                        "1719784739,5,0.0037,4.442,51.2243\n"
                                                        "1719784748,2,0.074,5.3106,50.9353\n"
                                                        "1719784749,5,0.0407,4.442,51.2243\n"
                                                        "1719784753,8,0.0444,4.3116,50.8148\n"
                                                        "1719784758,2,0.0166,5.3106,50.9353\n"
                                                        "1719784760,5,0.0241,4.442,51.2243\n"
                                                        "1719784763,8,0.0574,4.3116,50.8148\n"
                                                        "1719784768,2,0.0592,5.3106,50.9353\n"
                                                        "1719784770,5,0.0426,4.442,51.2243\n"
                                                        "1719784773,8,0.0592,4.3115,50.8148\n"
                                                        "1719784775,9,2.3995,4.3409,50.8356\n"
                                                        "1719784778,2,0.037,5.3106,50.9353\n"
                                                        "1719784783,8,0.0796,4.3115,50.8148\n"
                                                        "1719784785,9,1.6465,4.3408,50.8356\n"
                                                        "1719784788,2,0.0352,5.3106,50.9353\n"
                                                        "1719784790,5,0.0333,4.442,51.2243\n"
                                                        "1719784793,8,0.0814,4.3115,50.8148\n"
                                                        "1719784795,9,1.2913,4.3409,50.8356\n"
                                                        "1719784798,2,0.0352,5.3106,50.9353\n"
                                                        "1719784851,9,2.8509,4.3409,50.8356\n"
                                                        "1719784851,9,2.2866,4.3409,50.8356\n"
                                                        "1719784852,9,1.5004,4.3409,50.8356\n"
                                                        "1719784856,5,0.0426,4.442,51.2243\n"
                                                        "1719784856,2,0.0352,5.3106,50.9353\n"
                                                        "1719784857,2,0.037,5.3106,50.9353\n"
                                                        "1719784858,2,0.0222,5.3106,50.9353\n"
                                                        "1719784860,9,2.2293,4.3408,50.8355\n"
                                                        "1719784863,2,0.0204,5.3106,50.9353\n"
                                                        "1719784864,5,0.0222,4.442,51.2243\n"
                                                        "1719784870,9,1.6354,4.3408,50.8356\n"
                                                        "1719784870,8,0.037,4.3115,50.8148\n"
                                                        "1719784870,8,0.0703,4.3115,50.8148\n"
                                                        "1719784872,8,0.0444,4.3115,50.8148\n"
                                                        "1719784873,2,0.0278,5.3106,50.9353\n"
                                                        "1719784874,5,0.0278,4.442,51.2243\n"
                                                        "1719784874,8,0.0944,4.3115,50.8148\n"
                                                        "1719784880,9,1.3931,4.3409,50.8357\n"
                                                        "1719784883,2,0.0019,5.3106,50.9353\n"
                                                        "1719784884,5,0.0241,4.442,51.2243\n"
                                                        "1719784885,8,0.0555,4.3115,50.8148\n"
                                                        "1719784890,9,3.6353,4.3411,50.8359\n"
                                                        "1719784893,2,0.0296,5.3106,50.9353\n"
                                                        "1719784894,5,0.0389,4.442,51.2243\n"
                                                        "1719784895,8,0.0426,4.3115,50.8148\n"
                                                        "1719784901,9,1.8907,4.3411,50.8359\n"
                                                        "1719784903,2,0.0352,5.3106,50.9353\n"
                                                        "1719784904,8,0.013,4.3115,50.8148\n"
                                                        "1719784904,5,0.0444,4.442,51.2243\n"
                                                        "1719784911,9,1.8334,4.3411,50.8359\n"
                                                        "1719784913,2,0.05,5.3106,50.9353\n"
                                                        "1719784914,5,0.0333,4.442,51.2243\n"
                                                        "1719784914,8,0.0611,4.3115,50.8148\n"
                                                        "1719784923,2,0.037,5.3106,50.9353\n"
                                                        "1719784924,5,0.0352,4.442,51.2243\n"
                                                        "1719784924,8,0.0185,4.3115,50.8148\n"
                                                        "1719784933,2,0.0315,5.3106,50.9353\n"
                                                        "1719784934,5,0.0352,4.442,51.2243\n"
                                                        "1719784934,8,0.0389,4.3116,50.8148\n"
                                                        "1719784943,2,0.0056,5.3106,50.9353\n"
                                                        "1719784944,5,0.013,4.442,51.2243\n"
                                                        "1719784944,8,0.05,4.3116,50.8148\n"
                                                        "1719784951,9,0.4477,4.3409,50.8358\n"
                                                        "1719784953,2,0.0426,5.3106,50.9353\n"
                                                        "1719784954,5,0.0093,4.442,51.2243\n"
                                                        "1719784955,8,0.0222,4.3116,50.8148\n"
                                                        "1719784961,9,1.0915,4.3409,50.8357\n"
                                                        "1719784963,2,0.0444,5.3106,50.9353\n"
                                                        "1719784965,8,0.0148,4.3115,50.8148\n"
                                                        "1719784965,5,0.0296,4.442,51.2243\n"
                                                        "1719784971,9,0.1758,4.3409,50.8357\n"
                                                        "1719784973,2,0.0481,5.3106,50.9353\n"
                                                        "1719784975,8,0.0166,4.3115,50.8148\n"
                                                        "1719784975,5,0.013,4.442,51.2243\n"
                                                        "1719784981,9,0.7104,4.3408,50.8357\n"
                                                        "1719784984,2,0.0648,5.3106,50.9353\n"
                                                        "1719784991,9,0.124,4.3408,50.8357\n"
                                                        "1719784994,2,0.0333,5.3106,50.9353\n"
                                                        "1719784995,5,0.0166,4.442,51.2243\n"
                                                        "1719785001,9,0.9472,4.3407,50.8356\n"
                                                        "1719785004,2,0.0241,5.3106,50.9353\n"
                                                        "1719785005,8,0.037,4.3115,50.8147\n"
                                                        "1719785005,5,0.0185,4.442,51.2243\n"
                                                        "1719785011,9,0.1406,4.3407,50.8356\n"
                                                        "1719785014,2,0.037,5.3106,50.9353\n"
                                                        "1719785015,8,0.0241,4.3115,50.8148\n"
                                                        "1719785015,5,0.0056,4.442,51.2243\n"
                                                        "1719785021,9,0.0759,4.3407,50.8356\n"
                                                        "1719785025,5,0.0444,4.442,51.2243\n"
                                                        "1719785025,8,0.0185,4.3115,50.8148\n"
                                                        "1719785031,9,0.3867,4.3407,50.8356\n"
                                                        "1719785035,8,0.0111,4.3115,50.8148\n"
                                                        "1719785041,9,1.1988,4.3409,50.8357\n"
                                                        "1719785044,2,0.0148,5.3106,50.9353\n"
                                                        "1719785045,8,0.0019,4.3115,50.8148\n"
                                                        "1719785051,9,0.3959,4.3409,50.8357\n"
                                                        "1719785055,8,0.0426,4.3115,50.8148\n"
                                                        "1719785055,5,0.0296,4.442,51.2243\n"
                                                        "1719785061,9,0.7012,4.3408,50.8357\n"
                                                        "1719785065,8,0.0259,4.3115,50.8148\n"
                                                        "1719785065,5,0.0111,4.442,51.2243\n"
                                                        "1719785071,9,0.7789,4.3409,50.8358\n"
                                                        "1719785074,2,0.0518,5.3106,50.9353\n"
                                                        "1719785075,5,0.0444,4.442,51.2243\n"
                                                        "1719785075,8,0.0426,4.3115,50.8148\n"
                                                        "1719785081,9,2.4383,4.3409,50.8358\n"
                                                        "1719785084,2,0.0185,5.3106,50.9353\n"
                                                        "1719785085,8,0.0925,4.3115,50.8148\n"
                                                        "1719785085,5,0.0481,4.442,51.2243\n"
                                                        "1719785091,9,0.2035,4.3409,50.8358\n"
                                                        "1719785094,2,0.0426,5.3106,50.9353\n"
                                                        "1719785095,8,0.0944,4.3115,50.8148\n"
                                                        "1719785095,5,0.0222,4.442,51.2243\n"
                                                        "1719785101,9,0.9306,4.3409,50.8357\n"
                                                        "1719785104,2,0.0389,5.3106,50.9353\n"
                                                        "1719785105,5,0.0259,4.442,51.2243\n"
                                                        "1719785105,8,0.0222,4.3115,50.8148\n"
                                                        "1719785111,9,3.1709,4.3408,50.8357\n"
                                                        "1719785114,2,0.0222,5.3106,50.9353\n"
                                                        "1719785115,8,0.0241,4.3115,50.8148\n"
                                                        "1719785115,5,0.0315,4.442,51.2243\n"
                                                        "1719785121,9,0.494,4.3408,50.8357\n"
                                                        "1719785124,2,0.0204,5.3106,50.9353\n"
                                                        "1719785125,5,0.0166,4.442,51.2243\n"
                                                        "1719785125,8,0.0666,4.3115,50.8148\n"
                                                        "1719785132,9,0.4607,4.3408,50.8357\n"
                                                        "1719785134,2,0.0074,5.3106,50.9353\n"
                                                        "1719785135,5,0.0204,4.442,51.2243\n"
                                                        "1719785135,8,0.0333,4.3115,50.8148\n"
                                                        "1719785144,2,0.0093,5.3106,50.9353\n"
                                                        "1719785145,8,0.0518,4.3115,50.8148\n"
                                                        "1719785145,5,0.0981,4.442,51.2243\n"
                                                        "1719785154,2,0.0315,5.3106,50.9353\n"
                                                        "1719785155,5,0.0056,4.442,51.2243\n"
                                                        "1719785155,8,0.013,4.3115,50.8148\n"
                                                        "1719785164,2,0.0093,5.3106,50.9353\n"
                                                        "1719785165,5,0.0666,4.442,51.2243\n"
                                                        "1719785166,8,0.0278,4.3115,50.8148\n"
                                                        "1719785174,2,0.0333,5.3106,50.9353\n"
                                                        "1719785175,5,0.013,4.442,51.2243\n"
                                                        "1719785176,8,0.0315,4.3115,50.8148\n"
                                                        "1719785184,2,0.0296,5.3106,50.9353\n"
                                                        "1719785185,5,0.0259,4.442,51.2243\n"
                                                        "1719785194,2,0.0222,5.3106,50.9353\n"
                                                        "1719785196,5,0.074,4.442,51.2243\n"
                                                        "1719785196,8,0.0278,4.3115,50.8148\n"
                                                        "1719785202,9,2.0128,4.341,50.8358\n"
                                                        "1719785204,2,0.0222,5.3106,50.9353\n"
                                                        "1719785206,5,0.0019,4.442,51.2243\n"
                                                        "1719785206,8,0.0166,4.3115,50.8148\n"
                                                        "1719785212,9,1.369,4.3409,50.8358\n"
                                                        "1719785214,2,0.0407,5.3106,50.9353\n"
                                                        "1719785216,5,0.0166,4.442,51.2243\n"
                                                        "1719785216,8,0.0352,4.3116,50.8148\n"
                                                        "1719785222,9,1.7649,4.3408,50.8357\n";

                                 
          
        // Run the query and get the actual dynamic buffers
        auto actualBuffers = testHarness.runQuery(Util::countLines(expectedOutput), "TopDown").getOutput();


            // Iterate Through Buffers and Log Results
        // for (const auto& buffer : actualBuffers) {
        //     size_t numTuples = buffer.getNumberOfTuples();
        //     for (size_t i = 0; i < numTuples; ++i) {
        //         auto tuple = buffer[i];
        //         NES_INFO("Battery Monitoring Result -  Timestamp: {}, ID : {}, longitude: {},latitude: {}, speed: {}",
        //             tuple[0].read<uint64_t>(), // timestamp
        //             tuple[1].read<uint64_t>(), // id
        //             tuple[2].read<double>(), // longitude
        //             tuple[3].read<double>(),    // latitude
        //             tuple[4].read<double>()); // speed
        //     }
        // }

        exportToJson(actualBuffers, "query7_out.json");
        exportToCsv(actualBuffers, "query7_out.csv");

        const auto outputSchema = testHarness.getOutputSchema();
        auto tmpBuffers =
            TestUtils::createExpectedBufferFromCSVString(expectedOutput, outputSchema, testHarness.getBufferManager());
        auto expectedBuffers = TestUtils::createTestTupleBuffers(tmpBuffers, outputSchema);


        EXPECT_TRUE(TestUtils::buffersContainSameTuples(expectedBuffers, actualBuffers));


    } catch (const std::exception& e) {
        FAIL() << "Caught exception: " << e.what();
    }
}

} // namespace NES